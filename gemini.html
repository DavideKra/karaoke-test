<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Davide*Kra — Album 3D (LIGHT + Styles + Cine + Tutorial Auto)</title>

<link href="https://fonts.googleapis.com/css2?family=Rubik+Dirt&family=Roboto:wght@300;400;700;900&family=Playfair+Display:wght@600;700&family=Bodoni+Moda:wght@600;700&display=swap" rel="stylesheet" />

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:#050505;color:#fff}

/* sempre e solo pallino (mai freccia/hand) */
body{cursor:none;}
html, body, * { cursor:none !important; }
*:hover, *:active, *:focus { cursor:none !important; }
a, button, [role="button"], input, textarea, select { cursor:none !important; }

:root{ --hudTx: rgba(255,255,255,.9); }

/* Cursor canvas (trail leggero) */
#cursor-canvas{
  position:fixed; inset:0;
  z-index:80;
  pointer-events:none;
}

/* BG particles canvas */
#bg-canvas{
  position:fixed; inset:0;
  z-index:12;
  pointer-events:none;
}

/* FX layer (leggero) */
#fx-layer{
  position:fixed; inset:0;
  z-index:18;
  pointer-events:none;
  opacity:.9;
  will-change: opacity;
}

/* FX per stile (solo gradienti + filtri leggeri) */
body[data-active-style="thriller"] #fx-layer{
  background:
    radial-gradient(circle at 50% 40%, rgba(140,40,40,0.18) 0%, transparent 55%),
    radial-gradient(circle at 50% 60%, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.86) 70%);
  animation: fxPulse 2.0s linear infinite;
  box-shadow: inset 0 0 120px rgba(0,0,0,0.85);
  filter: contrast(1.08) brightness(0.95);
}
body[data-active-style="amore"] #fx-layer{
  background:
    radial-gradient(circle at 30% 30%, rgba(255,120,170,0.16) 0%, transparent 55%),
    radial-gradient(circle at 70% 70%, rgba(255,80,140,0.12) 0%, rgba(0,0,0,0.80) 70%);
  animation: fxPulse 3.2s ease-in-out infinite;
  filter: contrast(1.02) brightness(1.05);
}
body[data-active-style="sexy"] #fx-layer{
  background:
    radial-gradient(circle at 25% 30%, rgba(170,60,255,0.22) 0%, transparent 60%),
    radial-gradient(circle at 75% 40%, rgba(255,230,60,0.18) 0%, transparent 60%),
    radial-gradient(circle at 55% 80%, rgba(255,60,200,0.12) 0%, transparent 65%),
    radial-gradient(circle at 50% 60%, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.86) 72%);
  animation: fxPulse 2.6s ease-in-out infinite;
  filter: contrast(1.15) saturate(1.35) brightness(0.98);
}
body[data-active-style="normale"] #fx-layer{
  background:
    radial-gradient(circle at 50% 50%, rgba(200,200,255,0.06) 0%, transparent 70%),
    radial-gradient(circle at 50% 60%, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.82) 75%);
  animation:none;
  filter:none;
}
@keyframes fxPulse{
  0%{opacity:.78}
  50%{opacity:.98}
  100%{opacity:.78}
}

/* Stage */
#stage{
  position:fixed; inset:0;
  perspective:1800px;
  overflow:hidden;
  z-index:10;
}
#world{ position:absolute; inset:0; transform-style:preserve-3d; }

/* Scene: NO specchio */
.scene{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  transform-style:preserve-3d;
  background-repeat:no-repeat;
  background-position:center center;
  background-size:contain;
  will-change:transform,opacity;
  opacity:0;
}
.scene::before{
  content:"";
  position:absolute; inset:0;
  background:linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.82));
  pointer-events:none;
  z-index:1;
}
.scene > *{position:relative; z-index:2}

/* Thump */
@keyframes thumpAnim{
  0%{transform:scale(1)}
  50%{transform:scale(1.02)}
  100%{transform:scale(1)}
}
.thump-effect{ animation: thumpAnim .15s ease-out forwards; }

/* Meta (base) */
.meta{
  text-align:center;
  pointer-events:none;
  max-width:86vw;
  transition:opacity .35s ease, transform .35s ease, filter .35s ease;
  margin-bottom:40px;
}
.meta .title{
  margin:0;
  font-size:clamp(40px,7vw,80px);
  line-height:1.05;
  text-shadow:0 10px 30px rgba(0,0,0,1);
  font-family:"Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
  font-weight:900;
  letter-spacing:-1px;
}
.meta .artist{
  margin-top:12px;
  font-size:1.1rem;
  opacity:.75;
  letter-spacing:2px;
  text-transform:uppercase;
  text-shadow:0 10px 26px rgba(0,0,0,.9);
  font-family:"Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
}
.scene.is-playing .meta{
  opacity:0;
  transform:translateY(-10px);
  filter:blur(3px);
}

/* Typography per stile (titoli cover) */
.scene[data-style="thriller"] .meta .title{
  font-family:"Rubik Dirt", cursive;
  font-weight:400;
  letter-spacing:.2px;
  color:#ffd0d0;
  text-shadow:0 12px 44px rgba(0,0,0,1), 0 0 18px rgba(255,80,80,.25);
}
.scene[data-style="amore"] .meta .title{
  font-family:"Playfair Display", serif;
  font-weight:700;
  font-style:italic;
  letter-spacing:.2px;
  color:#ffe0f0;
  text-shadow:0 12px 44px rgba(0,0,0,1), 0 0 18px rgba(255,160,200,.18);
}
.scene[data-style="sexy"] .meta .title{
  font-family:"Bodoni Moda", serif;
  font-weight:700;
  letter-spacing:.55px;
  font-style:italic;
  color:#f7d2ff;
  text-shadow:
    0 12px 44px rgba(0,0,0,1),
    0 0 20px rgba(170,60,255,0.35),
    0 0 16px rgba(255,230,60,0.18);
}
.scene[data-style="normale"] .meta .title{
  font-family:"Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
  font-weight:900;
  letter-spacing:-1px;
  color:#ffffff;
}

/* ===== Tutorial auto-collapse ===== */
#tutorial{
  position:fixed; top:18px; left:18px; z-index:60;
  max-width:min(380px, 78vw);
}
#tutorial .panel{
  background:rgba(0,0,0,0.55);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:12px;
  backdrop-filter:blur(6px);
  overflow:hidden;
}
#tutorialToggle{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  background:transparent;
  border:0;
  color:#fff;
  font:800 12px/1.1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  letter-spacing:.9px;
  text-transform:uppercase;
  opacity:.92;
}
#tutorialToggle .x{
  display:none;
  font-weight:900;
  opacity:.85;
}
#tutorialBody{
  padding:10px 12px 12px 12px;
  font:12px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color:rgba(255,255,255,0.78);
  border-top:1px solid rgba(255,255,255,0.10);
}
#tutorialBody strong{color:#fff}

#tutorial.collapsed #tutorialBody{
  display:none;
}
#tutorial.open #tutorialToggle .x{display:inline;}

/* Mini-map */
#minimap{
  position:fixed; right:20px; top:50%; transform:translateY(-50%);
  z-index:40; display:flex; flex-direction:column; gap:14px; align-items:flex-end;
}
.mm-item{display:flex;align-items:center;justify-content:flex-end}
.mm-dot{
  width:8px;height:8px;border-radius:50%;
  border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);
  transition:all .2s ease;margin-left:12px;position:relative;
}
.mm-item.active .mm-dot{background:#fff;border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,0.35);transform:scale(1.25)}
.mm-item.playing .mm-dot::after{content:"";position:absolute;inset:-6px;border-radius:50%;border:1px solid rgba(255,255,255,0.7);opacity:.55}
.mm-label{
  font:11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  text-transform:uppercase; letter-spacing:1px; color:#fff;
  opacity:.28; transition:opacity .2s;
  text-shadow:0 2px 4px rgba(0,0,0,0.8);
}
.mm-item.active .mm-label{opacity:1;font-weight:700}

/* Karaoke */
#karaoke{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
  pointer-events:none; z-index:25; padding:40px;
}
#line{
  max-width:1100px; text-align:center; line-height:1.2; opacity:0;
  text-shadow:0 12px 44px rgba(0,0,0,1);
  font-size:clamp(30px,5vw,64px);

  font-family:"Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
  font-weight:900;
  letter-spacing:-1px;
  color:#fff;
}

/* Karaoke typography per stile */
body[data-active-style="thriller"] #line{
  font-family:"Rubik Dirt", cursive;
  font-weight:400;
  letter-spacing:.25px;
  color:#ff4a4a;
  text-shadow: 0 14px 55px rgba(0,0,0,1), 0 0 18px rgba(255,60,60,0.25);
}
body[data-active-style="amore"] #line{
  font-family:"Playfair Display", serif;
  font-weight:700;
  font-style:italic;
  letter-spacing:.15px;
  color:#ffe6f3;
  text-shadow: 0 14px 55px rgba(0,0,0,1), 0 0 18px rgba(255,160,200,0.18);
}
body[data-active-style="sexy"] #line{
  font-family:"Bodoni Moda", serif;
  font-weight:700;
  font-style:italic;
  letter-spacing:.55px;
  color:#f3c6ff;
  text-shadow:
    0 14px 60px rgba(0,0,0,1),
    0 0 22px rgba(170,60,255,0.40),
    0 0 14px rgba(255,230,60,0.18);
}
body[data-active-style="normale"] #line{
  font-family:"Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
  font-weight:900;
  letter-spacing:-1px;
  color:#fff;
}

/* Micro-transizioni leggere karaoke */
#line.k-enter{ transform:translateY(14px) scale(0.995); filter:blur(6px); opacity:0; }
#line.k-show { transform:none; filter:none; opacity:1; transition:opacity .14s ease, transform .20s ease, filter .20s ease; }
body[data-active-style="thriller"] #line.k-enter{ transform:translateY(10px); filter:blur(10px); }
body[data-active-style="amore"]    #line.k-enter{ transform:translateY(18px); filter:blur(7px); }
body[data-active-style="sexy"]     #line.k-enter{ transform:translateY(12px) scale(1.01); filter:blur(6px); }

/* Player title + controls */
#playerTitle{
  position:fixed; bottom:88px; left:40px; z-index:32;
  font:700 30px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color:#fff;
  opacity:0; transform:translateY(20px); transition:all .4s ease;
  text-shadow:0 10px 26px rgba(0,0,0,1);
}
#playerTitle.visible{opacity:1;transform:translateY(0)}
#playerTitle span{
  display:block; font-size:13px; font-weight:500; opacity:.65;
  margin-bottom:6px; text-transform:uppercase; letter-spacing:2px;
}

#controls{
  position:fixed; bottom:40px; left:40px; display:flex; gap:10px;
  font:13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  opacity:.92; z-index:31; user-select:none;
  align-items:center;
}
#controls button{
  background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.22);
  color:#fff; padding:8px 14px; border-radius:18px;
  transition:all .15s; font-weight:800; text-transform:uppercase; font-size:11px; letter-spacing:1px;
  position:relative;
}
#controls button:hover{background:#fff;color:#000}
#controls button:active{transform:scale(0.98)}
#controls button[data-tip]::after{
  content: attr(data-tip);
  position:absolute;
  left:50%; transform:translateX(-50%) translateY(-10px);
  bottom:100%;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  background:rgba(0,0,0,0.72);
  border:1px solid rgba(255,255,255,0.14);
  backdrop-filter:blur(6px);
  padding:8px 10px;
  border-radius:10px;
  font:12px/1.1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color:#fff;
  box-shadow:0 12px 40px rgba(0,0,0,0.55);
  transition:opacity .14s ease, transform .14s ease;
  max-width:min(360px, 70vw);
  overflow:hidden;
  text-overflow:ellipsis;
}
#controls button[data-tip]:hover::after{ opacity:1; transform:translateX(-50%) translateY(-16px); }

/* Cinematic: nascondi UI, ma lascia cover+karaoke+fx */
body.cinematic #minimap,
body.cinematic #controls,
body.cinematic #playerTitle,
body.cinematic #tutorial{
  display:none !important;
}

/* Bottone uscita cinematic */
#cineExit{
  position:fixed; top:18px; left:18px;
  z-index:90;
  display:none;
  background:rgba(0,0,0,0.62);
  color:#fff;
  border:1px solid rgba(255,255,255,0.16);
  border-radius:14px;
  padding:10px 14px;
  font:800 12px/1.1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  letter-spacing:.6px;
  text-transform:uppercase;
  backdrop-filter:blur(6px);
}
#cineExit:hover{background:#fff;color:#000}
body.cinematic #cineExit{display:block;}

@media (max-width:600px){
  #tutorial{max-width:82vw}
  #playerTitle{font-size:22px; bottom:88px; left:18px}
  #controls{left:18px; gap:8px; flex-wrap:wrap}
  #controls button{padding:8px 12px}
}
</style>
</head>

<body data-active-style="normale">

<canvas id="bg-canvas"></canvas>
<div id="fx-layer"></div>
<canvas id="cursor-canvas"></canvas>

<button id="cineExit" type="button">Torna all'interfaccia standard</button>

<div id="tutorial" class="open">
  <div class="panel">
    <button id="tutorialToggle" type="button" aria-expanded="true">
      <span>Come funziona</span>
      <span class="x">✕</span>
    </button>
    <div id="tutorialBody">
      <strong>Comandi</strong><br>
      • Scroll: ruota gli album<br>
      • Click copertina: Play/Pause<br>
      • Click titolo (mini-map): salta<br>
      • <strong>Shift+Scroll</strong>: scrub traccia<br>
      • CINE: nasconde UI (poi torna col bottone)
    </div>
  </div>
</div>

<div id="minimap" aria-label="Album map"></div>

<div id="stage"><div id="world"></div></div>
<div id="karaoke"><div id="line"></div></div>

<audio id="audioA" preload="metadata" crossorigin="anonymous"></audio>
<audio id="audioB" preload="metadata" crossorigin="anonymous"></audio>

<div id="playerTitle">
  <span id="pt-artist">Davide*Kra</span>
  <div id="pt-song">Track Name</div>
</div>

<div id="controls">
  <button id="prevTrack" data-tip="Traccia precedente">&laquo;&laquo;</button>
  <button id="back">−10s</button>
  <button id="play">PLAY</button>
  <button id="forward">+10s</button>
  <button id="nextTrack" data-tip="Traccia successiva">&raquo;&raquo;</button>
  <button id="cine" data-tip="Modalità Cinematic">CINE</button>
</div>

<script>
/* =========================
   TRACKS
   ========================= */
const tracks = [
  { artist:"Davide*Kra", title:"In throw", slug:"in-throw", bpm:90, style:"normale",
    cover:"https://i.ibb.co/4Z8mxCnm/In-Throw.png", audio:"DavideKra - 01 - In Throw.mp3", vtt:"DavideKra - 01 - In Throw.vtt" },
  { artist:"Davide*Kra", title:"Sai Tenere Un Segreto?", slug:"segreto", bpm:126, style:"thriller",
    cover:"https://i.ibb.co/KcmRRWd8/Sai-Tenere-Un-Segreto.png", audio:"DavideKra - 02 - Sai Tenere Un Segreto.mp3", vtt:"DavideKra - 02 - Sai Tenere Un Segreto.vtt" },
  { artist:"Davide*Kra", title:"2 Cose Insieme", slug:"2-cose", bpm:91, style:"amore",
    cover:"https://i.ibb.co/6JsXjd2M/2-cose-insieme.png", audio:"DavideKra - 03 - 2 Cose Insieme.mp3", vtt:"DavideKra - 03 - 2 Cose Insieme.vtt" },
  { artist:"Davide*Kra", title:"Interlude 01", slug:"interlude-01", bpm:91, style:"normale",
    cover:"https://i.ibb.co/8gL4yRyP/Interlude-01.png", audio:"DavideKra - 04 - Interlude.mp3", vtt:"DavideKra - 04 - Interlude.vtt" },
  { artist:"Davide*Kra", title:"Provincia Di Niente", slug:"provincia-niente", bpm:90, style:"normale",
    cover:"https://i.ibb.co/5x4tVsQN/Provincia-Di-Niente.png", audio:"DavideKra - 05 - Provincia Di Niente.mp3", vtt:"DavideKra - 05 - Provincia Di Niente.vtt" },
  { artist:"Davide*Kra", title:"Killer Verse 2025", slug:"killer-verse-2025", bpm:91, style:"normale",
    cover:"https://i.ibb.co/KpPmSjMd/Killer-Verse-2025.png", audio:"DavideKra - 06 - Killer Verse 2025.mp3", vtt:"DavideKra - 06 - Killer Verse 2025.vtt" },
  { artist:"Davide*Kra", title:"La 25ª Ora", slug:"la-25a-ora", bpm:150, style:"amore",
    cover:"https://i.ibb.co/P7fcR7w/La-25-Ora.png", audio:"DavideKra - 07 - La 25ª Ora.mp3", vtt:"DavideKra - 07 - La 25ª Ora.vtt" },
  { artist:"Davide*Kra", title:"Interlude 02", slug:"interlude-02", bpm:87, style:"normale",
    cover:"https://i.ibb.co/Sk9jx5X/Interlude-02.png", audio:"DavideKra - 08 - Interlude 02.mp3", vtt:"DavideKra - 08 - Interlude 02.vtt" },
  { artist:"Davide*Kra", title:"Killer Verse 2026", slug:"killer-verse-2026", bpm:93, style:"normale",
    cover:"https://i.ibb.co/B22SCJkz/Killer-Verse-2026.png", audio:"DavideKra - 09 - Killer Verse 2026.mp3", vtt:"DavideKra - 09 - Killer Verse 2026.vtt" },
  { artist:"Davide*Kra", title:"Conta", slug:"conta", bpm:124, style:"normale",
    cover:"https://i.ibb.co/mVLRsKNr/Conta.png", audio:"DavideKra - 10 - Conta.mp3", vtt:"DavideKra - 10 - Conta.vtt" },
  { artist:"Davide*Kra", title:"IA-Pocalypse", slug:"ia-pocalypse", bpm:90, style:"normale",
    cover:"https://i.ibb.co/PZbC5KbD/IA-pocalypse.png", audio:"DavideKra - 11 - IA-Pocalypse.mp3", vtt:"DavideKra - 11 - IA-Pocalypse.vtt" },
  { artist:"Davide*Kra", title:"Interlude 03", slug:"interlude-03", bpm:89, style:"normale",
    cover:"https://i.ibb.co/kgZ4QV1X/Interlude-03.png", audio:"DavideKra - 12 - Interlude 03.mp3", vtt:"DavideKra - 12 - Interlude 03.vtt" },
  { artist:"Davide*Kra", title:"La Marihuana Es Su Diabla", slug:"la-marihuana-es-su-diabla", bpm:55, style:"normale",
    cover:"https://i.ibb.co/Y7y2rcRh/La-Marihuana-Es-Su-Diabla.png", audio:"DavideKra - 13 - La Marihuana Es Su Diabla.mp3", vtt:"DavideKra - 13 - La Marihuana Es Su Diabla.vtt" },
  { artist:"Davide*Kra", title:"Figlio Degli Anni '80", slug:"figlio-degli-anni-80", bpm:88, style:"normale",
    cover:"https://i.ibb.co/My4Qk7B5/Figlio-Degli-Anni-80.png", audio:"DavideKra - 14 - Figlio degli anni '80.mp3", vtt:"DavideKra - 14 - Figlio degli anni '80.vtt" },
  { artist:"Davide*Kra", title:"Fammi Male", slug:"fammi-male", bpm:87, style:"sexy",
    cover:"https://i.ibb.co/gLHkXXvm/Fammi-Male.jpg", audio:"DavideKra - 15 - Fammi Male.mp3", vtt:"DavideKra - 15 - Fammi Male.vtt" },
  { artist:"Davide*Kra", title:"Lettere Di Sangue", slug:"lettere-di-sangue", bpm:91, style:"thriller",
    cover:"https://i.ibb.co/GfRv5W0K/Lettere-Di-Sangue.png", audio:"DavideKra - 16 - Lettere Di Sangue.mp3", vtt:"DavideKra - 16 - Lettere Di Sangue.vtt" },
  { artist:"Davide*Kra", title:"Mio Dio", slug:"mio-dio", bpm:87, style:"sexy",
    cover:"https://i.ibb.co/kgnLN3L4/Mio-Dio.jpg", audio:"DavideKra - 17 - Mio Dio.mp3", vtt:"DavideKra - 17 - Mio Dio.vtt" },
  { artist:"Davide*Kra", title:"Sempre Meglio Di Niente", slug:"sempre-meglio-di-niente", bpm:121, style:"amore",
    cover:"https://i.ibb.co/d0fvdSFC/Sempre-Meglio-Di-Niente.png", audio:"DavideKra - 18 - Sempre Meglio Di Niente.mp3", vtt:"DavideKra - 18 - Sempre Meglio Di Niente.vtt" },
  { artist:"Davide*Kra", title:"Perdiamoci di vista", slug:"perdiamoci-di-vista", bpm:76, style:"normale",
    cover:"https://i.ibb.co/d4v5qQGL/Perdiamoci-Di-Vista.jpg", audio:"DavideKra - 19 - Perdiamoci di vista.mp3", vtt:"DavideKra - 19 - Perdiamoci Di Vista.vtt" },
  { artist:"Davide*Kra", title:"Ping Pong", slug:"ping-pong", bpm:120, style:"normale",
    cover:"https://i.ibb.co/FL9YQh6c/Ping-Pong.png", audio:"DavideKra - 20 - Ping Pong.mp3", vtt:"DavideKra - 20 - Ping Pong.vtt" },
  { artist:"Davide*Kra", title:"Nera", slug:"nera", bpm:90, style:"thriller",
    cover:"https://i.ibb.co/G4bJyYzZ/Nera.png", audio:"DavideKra - 21 - Nera.mp3", vtt:"DavideKra - 21 - Nera.vtt" },
  { artist:"Davide*Kra", title:"Film Di Chaplin", slug:"film-di-chaplin", bpm:120, style:"amore",
    cover:"https://i.ibb.co/S4K7Y8xH/Film-Di-Chaplin.png", audio:"DavideKra - 22 - Film Di Champlin.mp3", vtt:"DavideKra - 22 - Film Di Champlin.vtt" }
];

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function encPath(p){ return encodeURI(p); }

/* =========================
   Tutorial auto-collapse
   ========================= */
const tutorialEl = document.getElementById("tutorial");
const tutorialToggle = document.getElementById("tutorialToggle");

function setTutorial(open){
  tutorialEl.classList.toggle("open", !!open);
  tutorialEl.classList.toggle("collapsed", !open);
  tutorialToggle.setAttribute("aria-expanded", open ? "true" : "false");
}
tutorialToggle.addEventListener("click", ()=>{
  const isOpen = tutorialEl.classList.contains("open");
  setTutorial(!isOpen);
});

/* mostra 5s aperto, poi collassa */
window.addEventListener("load", ()=>{
  setTutorial(true);
  setTimeout(()=>{
    if(!document.body.classList.contains("cinematic")) setTutorial(false);
  }, 5000);
});

/* =========================
   Modalità Cinematic
   ========================= */
const cineBtn = document.getElementById("cine");
const cineExit = document.getElementById("cineExit");

function setCinematic(on){
  document.body.classList.toggle("cinematic", !!on);
}
cineBtn.addEventListener("click", ()=> setCinematic(true));
cineExit.addEventListener("click", ()=> setCinematic(false));
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && document.body.classList.contains("cinematic")){
    setCinematic(false);
  }
});

/* =========================
   Preload leggero: cover + vtt + audio metadata (prossima)
   ========================= */
const preloadAudio = new Audio();
preloadAudio.preload = "metadata";
let lastPreloadedKey = "";

function preloadNext(index){
  const nextIndex = (index + 1) % tracks.length;
  const t = tracks[nextIndex];
  const key = t.audio + "|" + t.vtt + "|" + t.cover;
  if(key === lastPreloadedKey) return;
  lastPreloadedKey = key;

  // cover
  const img = new Image();
  img.decoding = "async";
  img.src = t.cover;

  // vtt (best effort)
  fetch(encPath(t.vtt), { cache:"force-cache" }).catch(()=>{});

  // audio metadata
  try{
    preloadAudio.src = encPath(t.audio);
    preloadAudio.load();
  }catch(e){}
}

/* =========================
   Particles LIGHT @30fps
   ========================= */
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d', { alpha:true });

let particles = [];
let cw=0, ch=0, dpr=1;
const FPS_BG = 30;
const BG_FRAME = 1000 / FPS_BG;

function resizeBgCanvas(){
  dpr = Math.min(window.devicePixelRatio || 1, 1.25);
  cw = bgCanvas.width  = Math.floor(window.innerWidth  * dpr);
  ch = bgCanvas.height = Math.floor(window.innerHeight * dpr);
  bgCanvas.style.width  = window.innerWidth + "px";
  bgCanvas.style.height = window.innerHeight + "px";
  bgCtx.setTransform(1,0,0,1,0,0);
}
window.addEventListener('resize', resizeBgCanvas);
resizeBgCanvas();

class Particle{
  constructor(style){ this.reset(style); }
  reset(style){
    this.style = style;
    this.x = Math.random()*cw;
    this.y = Math.random()*ch;
    this.life = Math.random()*200;

    if(style === "thriller"){
      this.vx = (Math.random()-0.5) * 0.8 * dpr;
      this.vy = (3.5 + Math.random()*4.5) * dpr;
      this.len = (12 + Math.random()*18) * dpr;
      this.a = 0.12 + Math.random()*0.22;

    } else if(style === "amore"){
      this.vx = (Math.random()-0.5) * 0.8 * dpr;
      this.vy = (1.0 + Math.random()*1.8) * dpr;
      this.r  = (3 + Math.random()*6) * dpr;
      this.a  = 0.14 + Math.random()*0.20;

    } else if(style === "sexy"){
      this.vx = (Math.random()-0.5) * 0.6 * dpr;
      this.vy = (-0.8 - Math.random()*1.4) * dpr;
      this.r  = (2 + Math.random()*7) * dpr;
      this.a  = 0.10 + Math.random()*0.18;
      const tones = ["170,60,255","255,230,60","255,60,200"];
      this.c = tones[(Math.random()*tones.length)|0];

    } else {
      this.vx = (Math.random()-0.5) * 0.7 * dpr;
      this.vy = (Math.random()-0.5) * 0.7 * dpr;
      this.r  = (2 + Math.random()*5) * dpr;
      this.a  = 0.10 + Math.random()*0.18;
    }
  }

  update(){
    this.life++;
    if(this.style === "thriller"){
      this.x += this.vx; this.y += this.vy;
      if(this.y > ch + 40*dpr){ this.y = -40*dpr; this.x = Math.random()*cw; }

    } else if(this.style === "amore"){
      this.y += this.vy;
      this.x += this.vx + Math.sin(this.life*0.02) * (0.6*dpr);
      if(this.y > ch + 30*dpr){ this.y = -30*dpr; this.x = Math.random()*cw; }

    } else if(this.style === "sexy"){
      this.y += this.vy;
      this.x += this.vx + Math.sin(this.life*0.02) * (0.6*dpr);
      if(this.y < -30*dpr){ this.y = ch + 30*dpr; this.x = Math.random()*cw; }
      if(this.x < -40*dpr) this.x = cw+40*dpr;
      if(this.x > cw+40*dpr) this.x = -40*dpr;

    } else {
      this.x += this.vx; this.y += this.vy;
      if(this.x < -40*dpr) this.x = cw+40*dpr;
      if(this.x > cw+40*dpr) this.x = -40*dpr;
      if(this.y < -40*dpr) this.y = ch+40*dpr;
      if(this.y > ch+40*dpr) this.y = -40*dpr;
    }
  }

  draw(){
    if(this.style === "thriller"){
      bgCtx.strokeStyle = `rgba(220,220,235,${this.a})`;
      bgCtx.lineWidth = 1*dpr;
      bgCtx.beginPath();
      bgCtx.moveTo(this.x, this.y);
      bgCtx.lineTo(this.x + this.vx, this.y + this.len);
      bgCtx.stroke();
      return;
    }

    bgCtx.beginPath();
    if(this.style === "sexy"){
      bgCtx.fillStyle = `rgba(${this.c},${this.a})`;
    } else if(this.style === "amore"){
      bgCtx.fillStyle = `rgba(255,140,185,${this.a})`;
    } else {
      bgCtx.fillStyle = `rgba(200,200,255,${this.a})`;
    }
    bgCtx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    bgCtx.fill();
  }
}

function targetCountForStyle(s){
  if(s === "thriller") return 90;
  if(s === "amore") return 70;
  if(s === "sexy") return 80;
  return 55;
}

let lastStyleApplied = null;
function setActiveStyle(styleKey){
  const s = styleKey || "normale";
  if(lastStyleApplied === s) return;
  lastStyleApplied = s;
  document.body.dataset.activeStyle = s;
  updateCanvasEffect(s);
}

function updateCanvasEffect(style){
  const s = style || "normale";
  const target = targetCountForStyle(s);
  while(particles.length < target) particles.push(new Particle(s));
  while(particles.length > target) particles.pop();
  particles.forEach(p => p.reset(s));
}

let lastBgTime = 0;
function loopBgCanvas(t){
  if(!lastBgTime) lastBgTime = t;
  const dt = t - lastBgTime;
  if(dt < BG_FRAME){ requestAnimationFrame(loopBgCanvas); return; }
  lastBgTime = t;

  bgCtx.clearRect(0,0,cw,ch);
  for(const p of particles){ p.update(); p.draw(); }
  requestAnimationFrame(loopBgCanvas);
}

/* =========================
   Scenes & World
   ========================= */
const world = document.getElementById("world");
const SCENE_DEPTH = 2200;

const scenes = tracks.map((trk,i)=>{
  const el = document.createElement("div");
  el.className="scene";
  el.dataset.style = trk.style;
  el.style.backgroundImage = `url("${trk.cover}")`;
  el.innerHTML = `
    <div class="meta">
      <div class="title">${trk.title}</div>
      <div class="artist">${trk.artist}</div>
    </div>`;

  el.addEventListener("click", ()=>{
    if(i !== activeIndex) jumpToIndex(i, true);
    else playOrToggle();
  });

  world.appendChild(el);
  return { el, z:-i*SCENE_DEPTH, track:trk, index:i };
});
const MAX_Z = SCENE_DEPTH * (tracks.length-1);

/* Mini-map */
const minimap = document.getElementById("minimap");
const dotItems = scenes.map((s,i)=>{
  const wrapper=document.createElement("div");
  wrapper.className="mm-item";
  wrapper.innerHTML=`<span class="mm-label">${s.track.title}</span><div class="mm-dot"></div>`;
  wrapper.addEventListener("click", ()=> jumpToIndex(i, false));
  minimap.appendChild(wrapper);
  return wrapper;
});

/* UI refs */
const ptSong=document.getElementById("pt-song");
const ptArtist=document.getElementById("pt-artist");
const playerTitleBlock=document.getElementById("playerTitle");
const line=document.getElementById("line");
const playBtn=document.getElementById("play");

const prevBtn=document.getElementById("prevTrack");
const nextBtn=document.getElementById("nextTrack");

function updateHUD(){
  const t=scenes[activeIndex].track;
  ptArtist.textContent = t.artist;
  ptSong.textContent   = t.title;
}
function updateURL(){
  const t = scenes[activeIndex].track;
  const hash = "#" + t.slug;
  if(location.hash !== hash) history.replaceState(null, "", hash);
}
function updatePrevNextTooltips(){
  const prevIndex = (activeIndex - 1 + scenes.length) % scenes.length;
  const nextIndex = (activeIndex + 1) % scenes.length;
  prevBtn.dataset.tip = "Prev: " + scenes[prevIndex].track.title;
  nextBtn.dataset.tip = "Next: " + scenes[nextIndex].track.title;
}

/* Camera & snap */
let cameraZ=0, targetZ=0, activeIndex=0, lastActiveIndex=-1;
const SPEED=0.95;
let snapTimer=null, snapArmed=false, hasThumped=false;

function computeActiveIndex(zVal){
  let bestI=0, bestD=Infinity;
  for(let i=0;i<scenes.length;i++){
    const rz = scenes[i].z + zVal;
    const d = Math.abs(rz);
    if(d<bestD){ bestD=d; bestI=i; }
  }
  return bestI;
}
function armSnap(){
  snapArmed=true; hasThumped=false;
  if(snapTimer) clearTimeout(snapTimer);
  snapTimer=setTimeout(()=>{
    if(!snapArmed) return;
    const nearest = Math.round(targetZ / SCENE_DEPTH) * SCENE_DEPTH;
    targetZ = clamp(nearest, 0, MAX_Z);
  }, 140);
}
function triggerThump(sceneIndex){
  const s=scenes[sceneIndex];
  if(!s || !s.el) return;
  s.el.classList.remove("thump-effect");
  void s.el.offsetWidth;
  s.el.classList.add("thump-effect");
}

let pendingPlayIndex = null;
function jumpToIndex(i, autoplay){
  targetZ = clamp(i*SCENE_DEPTH, 0, MAX_Z);
  snapArmed=false;
  pendingPlayIndex = autoplay ? i : null;
}

/* =========================
   Audio (crossfade + karaoke)
   ========================= */
const audioA=document.getElementById("audioA");
const audioB=document.getElementById("audioB");
const audios=[audioA,audioB];

let audioCtx=null, srcA=null, srcB=null, gA=null, gB=null;
let currentPlayer=0, playingIndex=null;
let vttSession=0, currentTrackEl=null;

function ensureAudioGraph(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  srcA = audioCtx.createMediaElementSource(audioA);
  srcB = audioCtx.createMediaElementSource(audioB);
  gA = audioCtx.createGain();
  gB = audioCtx.createGain();
  gA.gain.value = 1;
  gB.gain.value = 0;
  srcA.connect(gA).connect(audioCtx.destination);
  srcB.connect(gB).connect(audioCtx.destination);
}
function getCurrentAudio(){ return audios[currentPlayer]; }
function getOtherAudio(){ return audios[1-currentPlayer]; }
function getCurrentGain(){ return currentPlayer===0 ? gA : gB; }
function getOtherGain(){ return currentPlayer===0 ? gB : gA; }

function clearKaraoke(){
  vttSession++;
  line.style.opacity=0;
  line.textContent="";
  line.classList.remove("k-enter","k-show");
  if(currentTrackEl){
    try{ currentTrackEl.remove(); }catch(e){}
    currentTrackEl=null;
  }
}

function bindKaraokeTo(playerEl, trackObj){
  clearKaraoke();
  const mySession=vttSession;

  const tr=document.createElement("track");
  tr.kind="subtitles";
  tr.srclang="it";
  tr.label="lyrics";
  tr.src = encPath(trackObj.vtt);
  tr.default=true;
  playerEl.appendChild(tr);
  currentTrackEl=tr;

  tr.addEventListener("load", ()=>{
    if(mySession!==vttSession) return;

    const tt=tr.track;
    tt.mode="hidden";
    let lastCue=null;

    const refresh=()=>{
      if(mySession!==vttSession) return;
      if(playingIndex===null || activeIndex!==playingIndex) { line.style.opacity=0; return; }
      if(getCurrentAudio().paused) { line.style.opacity=0; return; }

      const a=tt.activeCues;
      if(!a || !a.length){ line.style.opacity=0; return; }

      const cue=a[0];
      if(cue===lastCue) return;
      lastCue=cue;

      line.classList.remove("k-show");
      line.classList.add("k-enter");
      line.style.opacity = 0;

      setTimeout(()=>{
        if(mySession!==vttSession) return;
        if(playingIndex===null || activeIndex!==playingIndex) { line.style.opacity=0; return; }
        if(getCurrentAudio().paused) { line.style.opacity=0; return; }

        line.textContent = cue.text;
        line.classList.remove("k-enter");
        line.classList.add("k-show");
        line.style.opacity = 1;
      }, 90);
    };

    tt.addEventListener("cuechange", refresh);
    playerEl.addEventListener("timeupdate", refresh);
    playerEl.addEventListener("seeked", ()=>{ lastCue=null; refresh(); });
    refresh();
  });
}

function updatePlayingUI(){
  const isPlaying = (playingIndex!==null && !getCurrentAudio().paused);
  playBtn.textContent = (isPlaying && activeIndex===playingIndex) ? "PAUSE" : "PLAY";

  scenes.forEach((s,i)=>{
    s.el.classList.toggle("is-playing", (playingIndex===i && isPlaying));
  });
  dotItems.forEach((d,i)=>{
    d.classList.toggle("active", i===activeIndex);
    d.classList.toggle("playing", (i===playingIndex && isPlaying));
  });

  if(playingIndex===null || activeIndex!==playingIndex || getCurrentAudio().paused){
    line.style.opacity=0;
  }
}

async function playIndex(index, mode){
  ensureAudioGraph();
  await audioCtx.resume();

  const wantIndex=index;
  const want=scenes[wantIndex].track;

  if(playingIndex===null){
    playingIndex=wantIndex;
    const a=getCurrentAudio();
    a.src = encPath(want.audio);
    a.load();
    setActiveStyle(want.style);
    bindKaraokeTo(a, want);
    await a.play();
    updatePlayingUI();
    preloadNext(wantIndex);
    return;
  }

  if(playingIndex===wantIndex){
    const a=getCurrentAudio();
    if(mode === "toggle"){
      if(a.paused) await a.play();
      else { a.pause(); line.style.opacity=0; }
    } else {
      if(a.paused) await a.play();
    }
    updatePlayingUI();
    preloadNext(wantIndex);
    return;
  }

  const FADE=1.0;
  const prevAudio=getCurrentAudio();
  const nextAudio=getOtherAudio();
  const prevGain=getCurrentGain();
  const nextGain=getOtherGain();

  playingIndex=wantIndex;
  setActiveStyle(want.style);

  nextAudio.pause();
  nextAudio.currentTime=0;
  nextAudio.src = encPath(want.audio);
  nextAudio.load();
  bindKaraokeTo(nextAudio, want);

  nextGain.gain.cancelScheduledValues(audioCtx.currentTime);
  prevGain.gain.cancelScheduledValues(audioCtx.currentTime);
  nextGain.gain.setValueAtTime(0, audioCtx.currentTime);
  prevGain.gain.setValueAtTime(prevGain.gain.value, audioCtx.currentTime);

  await nextAudio.play();
  nextGain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + FADE);
  prevGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + FADE);

  setTimeout(()=>{
    try{ prevAudio.pause(); prevAudio.removeAttribute("src"); prevAudio.load(); }catch(e){}
  }, (FADE*1000)+80);

  currentPlayer = 1-currentPlayer;
  updatePlayingUI();
  preloadNext(wantIndex);
}

async function playOrToggle(){
  await playIndex(activeIndex, "toggle");
}

/* Autoplay next quando finisce */
function handleEnded(endedEl){
  if(playingIndex===null) return;
  if(endedEl !== getCurrentAudio()) return;
  const nextIndex = (playingIndex + 1) % scenes.length;
  jumpToIndex(nextIndex, true);
}
audioA.addEventListener("ended", ()=>handleEnded(audioA));
audioB.addEventListener("ended", ()=>handleEnded(audioB));

/* Controls */
document.getElementById("play").addEventListener("click", playOrToggle);
document.getElementById("back").addEventListener("click", ()=>{
  const a=getCurrentAudio();
  a.currentTime = Math.max(0, (a.currentTime||0) - 10);
});
document.getElementById("forward").addEventListener("click", ()=>{
  const a=getCurrentAudio();
  a.currentTime = Math.min((a.duration||0), (a.currentTime||0) + 10);
});
prevBtn.addEventListener("click", ()=>{
  const idx = (activeIndex - 1 + scenes.length) % scenes.length;
  jumpToIndex(idx, true);
});
nextBtn.addEventListener("click", ()=>{
  const idx = (activeIndex + 1) % scenes.length;
  jumpToIndex(idx, true);
});

/* Wheel */
function scrub(deltaY){
  if(playingIndex===null) return;
  const a=getCurrentAudio();
  const seconds=(deltaY/100)*2.0;
  a.currentTime = clamp(a.currentTime + seconds, 0, (a.duration||a.currentTime+10));
  if(activeIndex!==playingIndex) line.style.opacity=0;
}
window.addEventListener("wheel",(e)=>{
  e.preventDefault();
  if(e.shiftKey){ scrub(e.deltaY); return; }
  targetZ = clamp(targetZ + e.deltaY * SPEED, 0, MAX_Z);
  armSnap();
},{passive:false});

/* Render loop */
function updateScenes(){
  activeIndex = computeActiveIndex(cameraZ);

  if(activeIndex !== lastActiveIndex){
    const t = scenes[activeIndex].track;
    setActiveStyle(t.style);
    updateHUD();
    updateURL();
    updatePrevNextTooltips();
    preloadNext(activeIndex);
    lastActiveIndex = activeIndex;
  }

  for(const s of scenes){
    const rz = s.z + cameraZ;
    const dist = Math.abs(rz);
    const t = clamp(1 - (dist/SCENE_DEPTH), 0, 1);
    const scale = 0.70 + t*0.30;
    const opacity = t;

    s.el.style.transform = `translateZ(${rz}px) scale(${scale})`;
    s.el.style.opacity = opacity.toFixed(3);
    s.el.style.pointerEvents = (opacity > 0.35) ? "auto" : "none";
  }

  updatePlayingUI();
}

function tick(){
  const diff = (targetZ - cameraZ);
  cameraZ += diff * 0.12;

  if(!hasThumped && Math.abs(diff) < 20 && Math.abs(targetZ % SCENE_DEPTH) < 10){
    triggerThump(activeIndex);
    hasThumped=true;
  }
  if(Math.abs(diff) < 0.35) cameraZ = targetZ;

  if(pendingPlayIndex !== null && Math.abs(diff) < 3){
    const idx = pendingPlayIndex;
    pendingPlayIndex = null;
    playIndex(idx, "force");
  }

  updateScenes();
  requestAnimationFrame(tick);
}

/* Parallax (leggero) */
let mouseX=0, mouseY=0;
window.addEventListener("mousemove", (e)=>{
  mouseX=(e.clientX/window.innerWidth)*2-1;
  mouseY=(e.clientY/window.innerHeight)*2-1;
  world.style.transform = `rotateY(${mouseX*4}deg) rotateX(${-mouseY*4}deg)`;
});

/* =========================
   Cursor: pallino + trail MINIMO @30fps
   ========================= */
const cursorCanvas = document.getElementById("cursor-canvas");
const cursorCtx = cursorCanvas.getContext("2d", { alpha:true });

let ccw=0, cch=0, cdpr=1;
const FPS_CURSOR = 30;
const CUR_FRAME = 1000 / FPS_CURSOR;

function resizeCursorCanvas(){
  cdpr = Math.min(window.devicePixelRatio || 1, 1.25);
  ccw = cursorCanvas.width  = Math.floor(window.innerWidth * cdpr);
  cch = cursorCanvas.height = Math.floor(window.innerHeight * cdpr);
  cursorCanvas.style.width  = window.innerWidth + "px";
  cursorCanvas.style.height = window.innerHeight + "px";
  cursorCtx.setTransform(1,0,0,1,0,0);
}
window.addEventListener("resize", resizeCursorCanvas);
resizeCursorCanvas();

let mx = window.innerWidth/2, my = window.innerHeight/2;
let trail = [];
const TRAIL_MAX = 16;

window.addEventListener("mousemove", (e)=>{
  mx = e.clientX; my = e.clientY;
  trail.push({ x: mx, y: my, t: performance.now() });
  if(trail.length > TRAIL_MAX) trail.shift();
});

/* IMPORTANT: non disegnare rettangoli neri con alpha (evita flash su GPU), pulisco e ridisegno */
let lastCurTime=0;
function drawCursor(t){
  if(!lastCurTime) lastCurTime = t;
  const dt = t - lastCurTime;
  if(dt < CUR_FRAME){ requestAnimationFrame(drawCursor); return; }
  lastCurTime = t;

  cursorCtx.clearRect(0,0,ccw,cch);

  const now = performance.now();

  cursorCtx.save();
  cursorCtx.lineCap="round";
  cursorCtx.lineJoin="round";

  for(let i=1;i<trail.length;i++){
    const a = trail[i-1], b = trail[i];
    const age = (now - b.t);
    const alpha = clamp(1 - age/300, 0, 1);
    cursorCtx.strokeStyle = `rgba(170,60,255,${0.20*alpha})`;
    cursorCtx.lineWidth = (4 - i*(2/TRAIL_MAX)) * cdpr;
    cursorCtx.beginPath();
    cursorCtx.moveTo(a.x*cdpr, a.y*cdpr);
    cursorCtx.lineTo(b.x*cdpr, b.y*cdpr);
    cursorCtx.stroke();
  }

  const pulse = 0.6 + Math.sin(now*0.012)*0.4;
  const r = (5 + pulse*2) * cdpr;

  cursorCtx.fillStyle = "rgba(255,255,255,0.92)";
  cursorCtx.beginPath();
  cursorCtx.arc(mx*cdpr, my*cdpr, r, 0, Math.PI*2);
  cursorCtx.fill();

  cursorCtx.restore();

  trail = trail.filter(p => (now - p.t) < 360);

  requestAnimationFrame(drawCursor);
}

/* INIT */
window.addEventListener("load", ()=>{
  // hash jump
  const hash = location.hash.slice(1);
  let startIndex = 0;
  if(hash){
    const idx = tracks.findIndex(t => t.slug === hash);
    if(idx >= 0) startIndex = idx;
  }

  activeIndex = startIndex;
  targetZ = startIndex * SCENE_DEPTH;
  cameraZ = targetZ;

  setActiveStyle(tracks[activeIndex].style);
  updateCanvasEffect(tracks[activeIndex].style);

  if(particles.length === 0){
    const n = targetCountForStyle(tracks[activeIndex].style);
    for(let i=0;i<n;i++) particles.push(new Particle(tracks[activeIndex].style));
  }

  preloadNext(activeIndex);

  requestAnimationFrame(loopBgCanvas);
  updateHUD();
  updatePrevNextTooltips();
  updateScenes();
  playerTitleBlock.classList.add("visible");
  requestAnimationFrame(tick);
  requestAnimationFrame(drawCursor);
});
</script>

</body>
</html>

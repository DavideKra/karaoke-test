<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Davide*Kra — Album 3D</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Rubik+Dirt&family=Roboto:wght@300;400;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff}

/* ===== STAGE ===== */
#stage{
  position:fixed; inset:0;
  perspective:1600px;
  overflow:hidden;
}
#world{position:absolute; inset:0; transform-style:preserve-3d;}

/* ===== SCENE ===== */
.scene{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  transform-style:preserve-3d;
  transition:opacity .25s ease;
  background-repeat:no-repeat;
  background-position:center;
  background-size:contain;
  will-change:transform,opacity;
}

/* overlay */
.scene::before{
  content:"";
  position:absolute; inset:0;
  background:linear-gradient(to bottom, rgba(0,0,0,.42), rgba(0,0,0,.90));
  pointer-events:none;
}
.scene > *{position:relative; z-index:2}

/* ===== META ===== */
.meta{
  text-align:center;
  transition:opacity .35s ease, transform .35s ease, filter .35s ease;
  pointer-events:none;
  max-width:86vw;
}
.meta .title{
  margin:0;
  font-size:clamp(34px,6vw,68px);
  line-height:1.05;
  text-shadow:0 12px 44px rgba(0,0,0,.95);
}
.meta .artist{
  margin-top:10px;
  opacity:.72;
  text-shadow:0 10px 36px rgba(0,0,0,.9);
}

/* meta sparisce SOLO sulla scena della traccia che sta suonando */
.scene.is-playing .meta{
  opacity:0;
  transform:translateY(-6px);
  filter:blur(.4px);
}

/* ===== STILI ===== */
.scene[data-style="thriller"] .meta .title{
  font-family:"Rubik Dirt", cursive;
  letter-spacing:.3px;
}
.scene[data-style="normale"] .meta .title{
  font-family:"Roboto", system-ui, sans-serif;
  font-weight:700;
  letter-spacing:.15px;
}
.scene[data-style="amore"] .meta .title{
  font-family:"Playfair Display", serif;
  font-weight:700;
  letter-spacing:.15px;
}

/* ===== HUD (hashtag) ===== */
#hud{
  position:fixed;
  top:18px; right:18px;
  z-index:30;
  font: 12.5px/1.2 "Roboto", system-ui, sans-serif;
  color:rgba(255,255,255,.85);
  background:rgba(0,0,0,.28);
  border:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
  border-radius:12px;
  backdrop-filter: blur(8px);
  user-select:none;
}
#hud .hash{
  font-weight:700;
  letter-spacing:.25px;
}
#hud .hint{
  margin-top:6px;
  font-size:11.5px;
  opacity:.7;
}

/* ===== KARAOKE ===== */
#karaoke{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
  z-index:15;
  padding:40px;
}
#line{
  max-width:1100px;
  text-align:center;
  line-height:1.25;
  opacity:0;
  transition:opacity .22s ease, transform .35s ease, filter .35s ease;
  text-shadow:0 12px 44px rgba(0,0,0,.95);
  font-size:clamp(30px,5vw,58px);
}

/* Font testo per stile (normale = Roboto) */
body[data-active-style="thriller"] #line{ font-family:"Rubik Dirt", cursive; }
body[data-active-style="normale"]  #line{ font-family:"Roboto", system-ui, sans-serif; font-weight:700; }
body[data-active-style="amore"]    #line{ font-family:"Roboto", system-ui, sans-serif; font-weight:700; }

/* ===== TRANSITIONS ===== */
.t-fade-in   { transform:none; filter:none; }
.t-pop       { transform:scale(1.08); filter:none; }
.t-slide-up  { transform:translateY(40px); filter:none; }
.t-slide-down{ transform:translateY(-40px); filter:none; }
.t-slide-left{ transform:translateX(60px); filter:none; }
.t-slide-right{transform:translateX(-60px); filter:none; }
.t-rotate    { transform:rotate(-3deg) scale(.98); filter:none; }
.t-blur      { transform:none; filter:blur(14px); }
.t-stretch   { transform:scaleY(.72); filter:none; }
.t-snap      { transform:scale(.92); filter:contrast(1.2); }
.t-jitter    { transform:translateX(-6px) rotate(.8deg); filter:none; }

/* ===== PLAYER ===== */
#audio{display:none}

#playerTitle{
  position:fixed;
  bottom:56px;
  left:50%;
  transform:translateX(-50%);
  z-index:22;
  font: 12.5px/1.2 "Roboto", system-ui, sans-serif;
  color:rgba(255,255,255,.85);
  opacity:.9;
  user-select:none;
  text-shadow:0 10px 28px rgba(0,0,0,.9);
}

#controls{
  position:fixed;
  bottom:26px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:24px;
  font: 13px/1.2 "Roboto", system-ui, sans-serif;
  opacity:.86;
  z-index:20;
  user-select:none;
}
#controls button{
  background:none;
  border:none;
  color:rgba(255,255,255,.85);
  cursor:pointer;
  padding:4px 6px;
}
#controls button:hover{ color:#fff; text-decoration:underline; }

/* ===== BREATH (bpm-driven) ===== */
@keyframes bgPump{
  0%   { transform:translateZ(var(--rz, 0px)) scale(var(--scale, 1)); }
  50%  { transform:translateZ(var(--rz, 0px)) scale(calc(var(--scale, 1) * var(--breatheScale, 1.12))); }
  100% { transform:translateZ(var(--rz, 0px)) scale(var(--scale, 1)); }
}
.scene.breathing{
  animation: bgPump var(--breatheDur, 1.2s) linear infinite;
}

@media (prefers-reduced-motion: reduce){
  .scene.breathing{ animation:none; }
  #line{ transition:none; }
}
</style>
</head>

<body data-active-style="normale">

<div id="hud">
  <div class="hash" id="hash">#</div>
  <div class="hint">Scroll = cambia scena • Play = avvia qui</div>
</div>

<div id="stage"><div id="world"></div></div>
<div id="karaoke"><div id="line"></div></div>

<audio id="audio" preload="metadata" crossorigin="anonymous"></audio>

<div id="playerTitle">—</div>
<div id="controls">
  <button id="back">−10s</button>
  <button id="play">play</button>
  <button id="forward">+10s</button>
</div>

<script>
/* =========================================================
   TRACKLIST
   ========================================================= */
const tracks = [
  {
    artist: "Davide*Kra",
    title: "In Throw",
    bpm: 90,
    style: "normale",
    cover: "https://i.ibb.co/9mtLF0JV/In-Throw.png",
    audio: "DavideKra - 01 - In Throw.mp3",
    vtt:   "DavideKra - 01 - In Throw.vtt"
  },
  {
    artist: "Davide*Kra",
    title: "Sai Tenere Un Segreto?",
    bpm: 126,
    style: "thriller",
    cover: "https://i.ibb.co/nsyZJK7W/Sai-Tenere-Un-Segreto.png",
    audio: "DavideKra - 02 - Sai Tenere Un Segreto.mp3",
    vtt:   "DavideKra - 02 - Sai Tenere Un Segreto.vtt"
  },
  {
    artist: "Davide*Kra",
    title: "2 cose insieme",
    bpm: 91,
    style: "normale",
    cover: "https://i.ibb.co/yndKknVM/2-cose-insieme.png",
    audio: "DavideKra - 03 - 2 Cose Insieme.mp3",
    vtt:   "DavideKra - 03 - 2 Cose Insieme.vtt"
  }
];

/* =========================================================
   STYLE PRESETS
   ========================================================= */
const STYLE = {
  thriller: {
    transitions: ["t-blur","t-rotate","t-jitter","t-snap","t-slide-up","t-slide-down","t-pop","t-stretch","t-fade-in"],
    breatheAmp: 1.10
  },
  normale: {
    transitions: ["t-fade-in","t-slide-up","t-slide-down","t-pop","t-slide-left","t-slide-right","t-snap"],
    breatheAmp: 1.00
  },
  amore: {
    transitions: ["t-fade-in","t-pop","t-slide-up","t-slide-right","t-slide-left","t-snap","t-stretch"],
    breatheAmp: 0.95
  }
};

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function bpmToBreath(bpm, styleKey){
  const s = STYLE[styleKey] || STYLE.normale;

  let dur = 120 / Math.max(40, bpm);
  dur = clamp(dur, 0.75, 2.2);

  let amp = 1.06 + (bpm - 70) * 0.0015;
  amp = clamp(amp, 1.06, 1.22) * s.breatheAmp;
  amp = clamp(amp, 1.06, 1.28);

  return { dur, amp };
}

function pickTransition(styleKey){
  const set = (STYLE[styleKey] || STYLE.normale).transitions;
  return set[(Math.random()*set.length)|0];
}

/* =========================================================
   HELPERS: hashtag
   ========================================================= */
function toHashTag(title){
  // rimuove spazi e simboli, lascia lettere/numeri
  const clean = (title || "")
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // no accenti
    .replace(/[^a-zA-Z0-9]+/g, " ")                   // separatori
    .trim()
    .split(/\s+/)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join("");
  return "#" + (clean || "Track");
}

/* =========================================================
   CREATE SCENES
   ========================================================= */
const world = document.getElementById("world");

/* più spazio tra tracce = più profondità */
const SCENE_DEPTH = 1700; // prima era ~1200

const scenes = tracks.map((t,i)=>{
  const s = document.createElement("div");
  s.className = "scene";
  s.dataset.style = t.style;
  s.style.backgroundImage = `url("${t.cover}")`;

  s.innerHTML = `
    <div class="meta">
      <div class="title">${t.title}</div>
      <div class="artist">${t.artist}</div>
    </div>
  `;
  world.appendChild(s);
  return { el:s, z:-i*SCENE_DEPTH, track:t, index:i };
});

/* =========================================================
   CAMERA SCROLL
   ========================================================= */
let cameraZ = 0;
let activeIndex = 0;

const MAX_Z = SCENE_DEPTH * (tracks.length - 1);
const SPEED = 0.9;

function computeActiveIndex(){
  let bestI=0, bestD=Infinity;
  for (let i=0;i<scenes.length;i++){
    const rz = scenes[i].z + cameraZ;
    const d = Math.abs(rz);
    if(d < bestD){ bestD=d; bestI=i; }
  }
  return bestI;
}

window.addEventListener("wheel",(e)=>{
  e.preventDefault();
  cameraZ = clamp(cameraZ + e.deltaY * SPEED, 0, MAX_Z);
  updateScenes();
},{passive:false});

/* =========================================================
   AUDIO + KARAOKE
   ========================================================= */
const audio = document.getElementById("audio");
const playBtn = document.getElementById("play");
const line = document.getElementById("line");
const hashEl = document.getElementById("hash");
const playerTitle = document.getElementById("playerTitle");

let currentTrackIndex = null; // traccia effettivamente in riproduzione/caricata
let trackEl = null;
let lastCue = null;
let karaokeBoundToIndex = null; // quale traccia ha attualmente i cue agganciati

function clearKaraoke(){
  lastCue = null;
  karaokeBoundToIndex = null;
  line.style.opacity = 0;
  line.textContent = "";
  if(trackEl){
    try{ trackEl.remove(); }catch(e){}
    trackEl = null;
  }
}

function setActiveStyle(styleKey){
  document.body.dataset.activeStyle = styleKey || "normale";
}

function loadTrack(index){
  const t = scenes[index].track;
  if(currentTrackIndex === index && audio.src) return;

  clearKaraoke();
  currentTrackIndex = index;

  audio.src = t.audio;
  setActiveStyle(t.style);

  trackEl = document.createElement("track");
  trackEl.kind = "subtitles";
  trackEl.srclang = "it";
  trackEl.label = "lyrics";
  trackEl.src = t.vtt;
  trackEl.default = true;
  audio.appendChild(trackEl);

  trackEl.addEventListener("load",()=>{
    const tt = trackEl.track;
    tt.mode = "hidden";
    karaokeBoundToIndex = index;

    const refresh = ()=>{
      // IMPORTANTISSIMO:
      // testo visibile SOLO se stai guardando lo "spicchio" della traccia in play
      if (activeIndex !== currentTrackIndex){
        line.style.opacity = 0;
        return;
      }
      const a = tt.activeCues;
      if(!a || !a.length){
        line.style.opacity = 0;
        return;
      }
      const cue = a[0];
      if(cue === lastCue) return;
      lastCue = cue;

      const tr = pickTransition(t.style);
      line.className = tr;
      line.style.opacity = 0;

      setTimeout(()=>{
        // ricontrolla dopo il delay (se nel frattempo hai scrollato)
        if (activeIndex !== currentTrackIndex){
          line.style.opacity = 0;
          return;
        }
        line.textContent = cue.text;
        line.className = "t-fade-in";
        line.style.opacity = 1;
      }, 160);
    };

    tt.addEventListener("cuechange", refresh);
    audio.addEventListener("timeupdate", refresh);
  });
}

function updatePlayingMeta(){
  scenes.forEach((s,i)=>{
    const isPlayingThis = (!audio.paused) && (currentTrackIndex === i);
    s.el.classList.toggle("is-playing", isPlayingThis);
  });
}

function setBreathing(){
  scenes.forEach((s,i)=>{
    const should = (!audio.paused) && (currentTrackIndex === i) && (activeIndex === i);
    s.el.classList.toggle("breathing", should);

    if(should){
      const { dur, amp } = bpmToBreath(s.track.bpm, s.track.style);
      s.el.style.setProperty("--breatheDur", `${dur}s`);
      s.el.style.setProperty("--breatheScale", `${amp}`);
    }
  });
}

function updateHUD(){
  const t = scenes[activeIndex].track;
  hashEl.textContent = toHashTag(t.title);
  playerTitle.textContent = `${t.artist} — ${t.title}`;
}

/* audio events */
audio.addEventListener("play", ()=>{ playBtn.textContent="pause"; updatePlayingMeta(); setBreathing(); });
audio.addEventListener("pause", ()=>{ playBtn.textContent="play"; updatePlayingMeta(); setBreathing(); });
audio.addEventListener("ended", ()=>{ playBtn.textContent="play"; updatePlayingMeta(); clearKaraoke(); setBreathing(); line.style.opacity = 0; });

/* play button behavior */
playBtn.addEventListener("click", async ()=>{
  const t = scenes[activeIndex].track;
  if(!t.audio || !t.vtt) return;

  if(audio.paused){
    loadTrack(activeIndex);
    await audio.play();
    return;
  }

  // se sta suonando:
  // - stessa traccia -> pausa
  // - traccia diversa -> switch e continua
  if(currentTrackIndex === activeIndex){
    audio.pause();
    clearKaraoke();
    line.style.opacity = 0;
  } else {
    loadTrack(activeIndex);
    await audio.play();
  }
});

/* seek */
document.getElementById("back").addEventListener("click", ()=>{
  audio.currentTime = Math.max(0, audio.currentTime - 10);
});
document.getElementById("forward").addEventListener("click", ()=>{
  audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10);
});

/* =========================================================
   RENDER
   ========================================================= */
function updateScenes(){
  scenes.forEach((s)=>{
    const rz = s.z + cameraZ;
    const dist = Math.abs(rz);

    const t = clamp(1 - (dist / SCENE_DEPTH), 0, 1);
    const scale = 0.70 + t * 0.30;     // un filo più “cinema”
    const opacity = t;

    s.el.style.setProperty("--rz", `${rz}px`);
    s.el.style.setProperty("--scale", `${scale}`);

    if(!s.el.classList.contains("breathing")){
      s.el.style.transform = `translateZ(${rz}px) scale(${scale})`;
    }
    s.el.style.opacity = opacity.toFixed(3);
  });

  activeIndex = computeActiveIndex();

  // (1) testo SOLO nello spicchio
  if (activeIndex !== currentTrackIndex){
    line.style.opacity = 0;
  }

  // (2) HUD + player title
  updateHUD();

  // (3) respiro legato a scena attiva
  setBreathing();
}

updateScenes();
</script>

</body>
</html>

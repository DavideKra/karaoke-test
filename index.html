<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Davide*Kra — Album 3D (Stable + Slider + Shuffle/Repeat)</title>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Rubik+Dirt&family=Roboto:wght@300;400;700;900&family=Playfair+Display:wght@600;700&family=Bodoni+Moda:wght@600;700&display=swap" rel="stylesheet" />

<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#050505;color:#fff}
  body{overflow:hidden}

  /* IMPORTANT: preveniamo i flash bianchi da compositing/GPU:
     - niente mix-blend-mode / filtri full-screen / backdrop-filter
     - layer principali con background sempre scuro
  */
  #stage, #world{background:#050505}
  canvas{background:transparent; display:block}

  /* Hide cursor ONLY on desktop (fine pointer) */
  @media (hover:hover) and (pointer:fine){
    html,body,*{cursor:none !important;}
  }

  :root{
    --panel-bg: rgba(0,0,0,0.55);
    --panel-bd: rgba(255,255,255,0.14);
    --tx-dim: rgba(255,255,255,0.72);
  }

  /* ===== Loader ===== */
  #loader{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background:#050505;
  }
  #loader.hide{opacity:0; pointer-events:none; transition:opacity .55s ease;}
  #loaderBox{width:min(720px, 90vw); text-align:center; padding:22px 18px;}
  #loaderTitle{
    font:900 clamp(22px, 4vw, 42px)/1.12 "Roboto", sans-serif;
    letter-spacing:-0.5px;
    text-shadow:0 14px 60px rgba(0,0,0,1);
  }
  #loaderBounce{display:inline-block; animation:bounce .95s ease-in-out infinite;}
  @keyframes bounce{0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)}}
  #loaderSub{margin-top:10px; font:12px/1.4 "Roboto", sans-serif; letter-spacing:2px; text-transform:uppercase; opacity:.72;}
  #loaderBarWrap{
    margin:18px auto 0; width:min(520px, 86vw); height:10px;
    border-radius:999px; background:rgba(255,255,255,0.10);
    border:1px solid rgba(255,255,255,0.14); overflow:hidden;
  }
  #loaderBar{
    height:100%; width:0%;
    border-radius:999px;
    background:linear-gradient(90deg, rgba(170,60,255,0.9), rgba(255,230,60,0.9));
  }
  #loaderPct{margin-top:10px; font:12px/1 "Roboto", sans-serif; opacity:.75;}

  /* ===== Cursor Canvas (neon dot + trail) ===== */
  #cursor-canvas{position:fixed; inset:0; z-index:80; pointer-events:none;}

  /* ===== Stage ===== */
  #stage{
    position:fixed; inset:0;
    perspective:1600px;
    overflow:hidden;
    z-index:10;
  }
  #world{position:absolute; inset:0; transform-style:preserve-3d;}

  /* ===== Scene ===== */
  .scene{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    transform-style:preserve-3d;
    will-change: transform, opacity;
    opacity:0;
    pointer-events:none;
  }

  /* COVER: immagine semplice, senza riflesso, senza ombre, senza filtri */
  .cover{
    max-width:min(88vw, 1050px);
    max-height:72vh;
    width:auto;
    height:auto;
    object-fit:contain;
    display:block;
    user-select:none;
    -webkit-user-drag:none;
    border-radius:0;
    box-shadow:none !important;
    filter:none !important;
  }

  .meta{
    position:absolute;
    left:50%; top:68%;
    transform:translateX(-50%);
    text-align:center;
    width:min(900px, 92vw);
    pointer-events:none;
  }
  .meta .title{
    margin:0;
    font-size:clamp(26px, 5vw, 54px);
    line-height:1.06;
    font-family:"Roboto", sans-serif;
    font-weight:900;
    letter-spacing:-0.5px;
    text-shadow:0 10px 30px rgba(0,0,0,1);
  }
  .meta .artist{
    margin-top:10px;
    font:12px/1 "Roboto", sans-serif;
    letter-spacing:2px;
    text-transform:uppercase;
    opacity:.72;
    text-shadow:0 10px 26px rgba(0,0,0,1);
  }
  .scene.is-playing .meta{
    opacity:0;
    transition:opacity .22s ease;
  }

  /* ===== Tutorial (no blur) ===== */
  #tutorial{
    position:fixed; top:18px; left:18px; z-index:60;
    font:12px/1.5 "Roboto", sans-serif;
    color:var(--tx-dim);
    pointer-events:none;
    background:var(--panel-bg);
    padding:10px 14px;
    border-radius:10px;
    border:1px solid var(--panel-bd);
    max-width:min(360px, 72vw);
  }
  #tutorial strong{color:#fff}

  /* ===== Mini-map ===== */
  #minimap{
    position:fixed; right:18px; top:50%; transform:translateY(-50%);
    z-index:40; display:flex; flex-direction:column; gap:12px; align-items:flex-end;
  }
  .mm-item{display:flex; align-items:center; justify-content:flex-end; cursor:pointer; user-select:none}
  .mm-dot{
    width:8px;height:8px;border-radius:50%;
    border:1px solid rgba(255,255,255,.30);
    background:rgba(255,255,255,.10);
    transition:all .2s ease;
    margin-left:10px;
  }
  .mm-item:hover .mm-dot{background:#fff; transform:scale(1.2)}
  .mm-item.active .mm-dot{background:#fff; border-color:#fff; transform:scale(1.3)}
  .mm-item.playing .mm-dot{box-shadow:0 0 12px rgba(170,60,255,.55), 0 0 12px rgba(255,230,60,.35)}
  .mm-label{
    font:11px "Roboto", sans-serif;
    text-transform:uppercase;
    letter-spacing:1px;
    color:#fff;
    opacity:.28;
    transition:opacity .2s ease;
    text-shadow:0 2px 4px rgba(0,0,0,0.85);
    max-width:260px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .mm-item:hover .mm-label, .mm-item.active .mm-label{opacity:1; font-weight:700}

  /* ===== Karaoke ===== */
  #karaoke{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none; z-index:25; padding:40px;
  }
  #line{
    max-width:1100px; text-align:center; line-height:1.2; opacity:0;
    transition:opacity .18s ease, transform .25s ease;
    text-shadow:0 12px 44px rgba(0,0,0,1);
    font-size:clamp(22px,4.5vw,54px);
    font-family:"Roboto", sans-serif;
    font-weight:900;
  }

  /* ===== Player Title (più in alto) ===== */
  #playerTitle{
    position:fixed; left:40px; bottom:182px; z-index:32;
    opacity:0; transform:translateY(16px); transition:all .35s ease;
    text-shadow:0 10px 30px rgba(0,0,0,1);
    letter-spacing:-0.5px;
    font:900 28px/1.05 "Roboto", sans-serif;
  }
  #playerTitle.visible{opacity:1; transform:translateY(0)}
  #playerTitle span{
    display:block;
    font:12px/1 "Roboto", sans-serif;
    opacity:.65;
    margin-bottom:6px;
    letter-spacing:2px;
    text-transform:uppercase;
    font-weight:400;
  }

  /* ===== Seekbar ===== */
  #seekbar{
    position:fixed;
    left:40px;
    bottom:136px;
    width:clamp(280px, 38vw, 560px);
    z-index:33;
    opacity:0;
    transform:translateY(10px);
    transition:opacity .22s ease, transform .22s ease;
    pointer-events:none;
  }
  #seekbar.visible{opacity:1; transform:translateY(0); pointer-events:auto;}
  #seek{
    width:100%;
    -webkit-appearance:none;
    appearance:none;
    height:8px;
    border-radius:999px;
    background:rgba(255,255,255,0.14);
    border:1px solid rgba(255,255,255,0.18);
    outline:none;
  }
  #seek:disabled{opacity:.35}
  #seek::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width:18px;height:18px;border-radius:50%;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(0,0,0,0.35);
    box-shadow:0 0 18px rgba(170,60,255,0.65), 0 0 14px rgba(255,230,60,0.45);
  }
  #seek::-moz-range-thumb{
    width:18px;height:18px;border-radius:50%;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(0,0,0,0.35);
    box-shadow:0 0 18px rgba(170,60,255,0.65), 0 0 14px rgba(255,230,60,0.45);
  }
  .seek-times{
    display:flex; justify-content:space-between;
    margin-top:6px;
    font:11px/1.2 "Roboto", sans-serif;
    opacity:.7;
    letter-spacing:.8px;
    user-select:none;
  }

  /* ===== Controls ===== */
  #controls{
    position:fixed; left:40px; bottom:40px;
    display:flex; flex-direction:column; gap:10px;
    z-index:31;
    user-select:none;
    align-items:flex-start;
    font:13px/1.2 "Roboto", sans-serif;
    opacity:.95;
  }
  .controls-row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .controls-row.secondary{opacity:.95}

  #controls button{
    background:rgba(255,255,255,0.10);
    border:1px solid rgba(255,255,255,0.22);
    color:#fff;
    cursor:pointer;
    padding:8px 14px;
    border-radius:18px;
    transition:transform .12s ease, background .12s ease, color .12s ease;
    font-weight:800;
    text-transform:uppercase;
    font-size:11px;
    letter-spacing:1px;
  }
  #controls button:hover{background:#fff; color:#000}
  #controls button:active{transform:scale(0.98)}
  #controls button.on{background:#fff; color:#000; border-color:#fff}

  /* ===== Responsive ===== */
  @media (max-width:600px){
    #tutorial{max-width:80vw}
    #playerTitle{left:18px; bottom:210px; font-size:22px}
    #seekbar{left:18px; bottom:168px; width:calc(100vw - 36px)}
    #controls{left:18px}
  }

  /* ===== MOBILE MODE (alleggerita) ===== */
  #mobileApp{display:none;}
  body[data-mode="mobile"]{overflow:auto}
  body[data-mode="mobile"] #stage,
  body[data-mode="mobile"] #minimap,
  body[data-mode="mobile"] #tutorial,
  body[data-mode="mobile"] #cursor-canvas,
  body[data-mode="mobile"] #karaoke,
  body[data-mode="mobile"] #playerTitle,
  body[data-mode="mobile"] #seekbar,
  body[data-mode="mobile"] #controls{
    display:none !important;
  }

  body[data-mode="mobile"] #mobileApp{
    display:block;
    position:fixed; inset:0; z-index:10;
    background:#050505;
  }
  #mTop{
    padding:16px;
    border-bottom:1px solid rgba(255,255,255,0.10);
    background:rgba(0,0,0,0.55);
  }
  #mNow{
    display:grid;
    grid-template-columns:74px 1fr;
    gap:12px;
    align-items:center;
  }
  #mCover{
    width:74px; height:74px;
    background-size:cover;
    background-position:center;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    user-select:none;
  }
  #mSong{font:900 18px/1.15 "Roboto", sans-serif; text-shadow:0 10px 30px rgba(0,0,0,1);}
  #mArtist{margin-top:6px; font:12px/1 "Roboto", sans-serif; letter-spacing:2px; opacity:.7; text-transform:uppercase;}

  #mLyric{
    margin-top:12px;
    min-height:44px;
    font:900 20px/1.15 "Roboto", sans-serif;
    text-shadow:0 10px 30px rgba(0,0,0,1);
    opacity:.95;
  }

  #mSeekWrap{margin-top:12px;}
  #mSeek{
    width:100%;
    -webkit-appearance:none; appearance:none;
    height:8px; border-radius:999px;
    background:rgba(255,255,255,0.14);
    border:1px solid rgba(255,255,255,0.18);
    outline:none;
  }
  #mSeek::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width:18px;height:18px;border-radius:50%;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(0,0,0,0.35);
  }
  #mTimes{
    display:flex; justify-content:space-between;
    margin-top:6px;
    font:11px/1.2 "Roboto", sans-serif;
    opacity:.7;
    letter-spacing:.8px;
  }

  #mControls{
    margin-top:12px;
    display:flex;
    gap:10px;
  }
  #mControls button{
    flex:1;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(255,255,255,0.10);
    border:1px solid rgba(255,255,255,0.22);
    color:#fff;
    font-weight:900;
    letter-spacing:1px;
    text-transform:uppercase;
    font-size:11px;
  }
  #mControls button:active{transform:scale(0.99)}
  #mControls button.on{background:#fff; color:#000; border-color:#fff}

  #mList{
    position:fixed; left:0; right:0; top:188px; bottom:0;
    overflow:auto;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    -webkit-overflow-scrolling:touch;
  }
  .mTrack{
    width:100%;
    display:grid;
    grid-template-columns:44px 1fr auto;
    gap:12px;
    align-items:center;
    text-align:left;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.12);
    background:rgba(0,0,0,0.35);
    color:#fff;
  }
  .mTrack .cov{width:44px;height:44px;border-radius:12px;background-size:cover;background-position:center;border:1px solid rgba(255,255,255,0.10)}
  .mTrack .t{font:800 14px/1.15 "Roboto", sans-serif}
  .mTrack .a{margin-top:4px;font:11px/1 "Roboto", sans-serif; opacity:.65; letter-spacing:1.2px; text-transform:uppercase}
  .mTrack .state{font:900 11px/1 "Roboto", sans-serif; opacity:.7}
  .mTrack.active{border-color: rgba(255,255,255,0.28)}
  .mTrack.playing{border-color: rgba(170,60,255,0.40); background: rgba(170,60,255,0.12)}
</style>
</head>

<body data-mode="desktop">

<div id="loader" aria-label="Caricamento">
  <div id="loaderBox">
    <div id="loaderTitle"><span id="loaderBounce">Davide*Kra — Sai Tenere Un Segreto?</span></div>
    <div id="loaderSub">Caricamento in corso…</div>
    <div id="loaderBarWrap"><div id="loaderBar"></div></div>
    <div id="loaderPct">0%</div>
  </div>
</div>

<canvas id="cursor-canvas"></canvas>

<div id="tutorial">
  <strong>Come funziona</strong><br>
  • Scroll: ruota gli album<br>
  • Click su titolo: salta<br>
  • Click copertina: Play/Pause<br>
  • <strong>Shift+Scroll</strong>: scrub traccia
</div>

<div id="minimap" aria-label="Album map"></div>

<div id="stage"><div id="world"></div></div>

<div id="karaoke"><div id="line"></div></div>

<audio id="audioA" preload="metadata" crossorigin="anonymous"></audio>
<audio id="audioB" preload="metadata" crossorigin="anonymous"></audio>

<div id="playerTitle">
  <span id="pt-artist">Davide*Kra</span>
  <div id="pt-song">Track Name</div>
</div>

<div id="seekbar" aria-label="Posizione traccia">
  <input id="seek" type="range" min="0" max="1000" value="0" step="1" />
  <div class="seek-times">
    <span id="seekCur">0:00</span>
    <span id="seekDur">0:00</span>
  </div>
</div>

<div id="controls">
  <div class="controls-row primary">
    <button id="prevTrack">««</button>
    <button id="back">−10s</button>
    <button id="play">PLAY</button>
    <button id="forward">+10s</button>
    <button id="nextTrack">»»</button>
  </div>
  <div class="controls-row secondary">
    <button id="shuffle">SHUFFLE: OFF</button>
    <button id="repeat">REPEAT: NO</button>
  </div>
</div>

<!-- Mobile UI -->
<div id="mobileApp" aria-label="Mobile player">
  <div id="mTop">
    <div id="mNow">
      <div id="mCover" role="button" aria-label="Play/Pause"></div>
      <div>
        <div id="mSong">Track Name</div>
        <div id="mArtist">Davide*Kra</div>
      </div>
    </div>

    <div id="mLyric"> </div>

    <div id="mSeekWrap">
      <input id="mSeek" type="range" min="0" max="1000" value="0" step="1" />
      <div id="mTimes"><span id="mCur">0:00</span><span id="mDur">0:00</span></div>
    </div>

    <div id="mControls">
      <button id="mPrev">PREV</button>
      <button id="mPlay">PLAY</button>
      <button id="mNext">NEXT</button>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px;">
      <button id="mShuffle" style="flex:1;">SHUFFLE: OFF</button>
      <button id="mRepeat" style="flex:1;">REPEAT: NO</button>
    </div>
  </div>

  <div id="mList" aria-label="Lista tracce"></div>
</div>

<script>
/* =========================================================
   NOTE SUI "FLASH BIANCHI" (fix applicati)
   ---------------------------------------------------------
   I flash di solito arrivano da glitch di compositing GPU:
   - layer full-screen con filter / mix-blend-mode / backdrop-filter
   - troppi shadow/blur su elementi grandi
   - resize canvas/layer che “sbianca” per un frame

   Qui ho:
   ✅ rimosso fx-layer + blend-mode + blur/backdrop-filter full-screen
   ✅ cover rese IMG pure (niente riflesso, niente ombre/filtri)
   ✅ canvas cursor sempre trasparente, background sempre #050505
   ✅ scene più semplici e stabili (meno roba che può sparire)
========================================================= */

/* =========================
   TRACKS
   ========================= */
const tracks = [
  { artist:"Davide*Kra", title:"In throw", slug:"in-throw",
    cover:"https://i.ibb.co/4Z8mxCnm/In-Throw.png", audio:"DavideKra - 01 - In Throw.mp3", vtt:"DavideKra - 01 - In Throw.vtt" },

  { artist:"Davide*Kra", title:"Sai Tenere Un Segreto?", slug:"segreto",
    cover:"https://i.ibb.co/KcmRRWd8/Sai-Tenere-Un-Segreto.png", audio:"DavideKra - 02 - Sai Tenere Un Segreto.mp3", vtt:"DavideKra - 02 - Sai Tenere Un Segreto.vtt" },

  { artist:"Davide*Kra", title:"2 Cose Insieme", slug:"2-cose",
    cover:"https://i.ibb.co/6JsXjd2M/2-cose-insieme.png", audio:"DavideKra - 03 - 2 Cose Insieme.mp3", vtt:"DavideKra - 03 - 2 Cose Insieme.vtt" },

  { artist:"Davide*Kra", title:"Interlude 01", slug:"interlude-01",
    cover:"https://i.ibb.co/8gL4yRyP/Interlude-01.png", audio:"DavideKra - 04 - Interlude.mp3", vtt:"DavideKra - 04 - Interlude.vtt" },

  { artist:"Davide*Kra", title:"Provincia Di Niente", slug:"provincia-niente",
    cover:"https://i.ibb.co/5x4tVsQN/Provincia-Di-Niente.png", audio:"DavideKra - 05 - Provincia Di Niente.mp3", vtt:"DavideKra - 05 - Provincia Di Niente.vtt" },

  { artist:"Davide*Kra", title:"Killer Verse 2025", slug:"killer-verse-2025",
    cover:"https://i.ibb.co/KpPmSjMd/Killer-Verse-2025.png", audio:"DavideKra - 06 - Killer Verse 2025.mp3", vtt:"DavideKra - 06 - Killer Verse 2025.vtt" },

  { artist:"Davide*Kra", title:"La 25ª Ora", slug:"la-25a-ora",
    cover:"https://i.ibb.co/P7fcR7w/La-25-Ora.png", audio:"DavideKra - 07 - La 25ª Ora.mp3", vtt:"DavideKra - 07 - La 25ª Ora.vtt" },

  { artist:"Davide*Kra", title:"Interlude 02", slug:"interlude-02",
    cover:"https://i.ibb.co/Sk9jx5X/Interlude-02.png", audio:"DavideKra - 08 - Interlude 02.mp3", vtt:"DavideKra - 08 - Interlude 02.vtt" },

  { artist:"Davide*Kra", title:"Killer Verse 2026", slug:"killer-verse-2026",
    cover:"https://i.ibb.co/B22SCJkz/Killer-Verse-2026.png", audio:"DavideKra - 09 - Killer Verse 2026.mp3", vtt:"DavideKra - 09 - Killer Verse 2026.vtt" },

  { artist:"Davide*Kra", title:"Conta", slug:"conta",
    cover:"https://i.ibb.co/mVLRsKNr/Conta.png", audio:"DavideKra - 10 - Conta.mp3", vtt:"DavideKra - 10 - Conta.vtt" },

  { artist:"Davide*Kra", title:"IA-Pocalypse", slug:"ia-pocalypse",
    cover:"https://i.ibb.co/PZbC5KbD/IA-pocalypse.png", audio:"DavideKra - 11 - IA-Pocalypse.mp3", vtt:"DavideKra - 11 - IA-Pocalypse.vtt" },

  { artist:"Davide*Kra", title:"Interlude 03", slug:"interlude-03",
    cover:"https://i.ibb.co/kgZ4QV1X/Interlude-03.png", audio:"DavideKra - 12 - Interlude 03.mp3", vtt:"DavideKra - 12 - Interlude 03.vtt" },

  { artist:"Davide*Kra", title:"La Marihuana Es Su Diabla", slug:"la-marihuana-es-su-diabla",
    cover:"https://i.ibb.co/Y7y2rcRh/La-Marihuana-Es-Su-Diabla.png", audio:"DavideKra - 13 - La Marihuana Es Su Diabla.mp3", vtt:"DavideKra - 13 - La Marihuana Es Su Diabla.vtt" },

  { artist:"Davide*Kra", title:"Figlio Degli Anni '80", slug:"figlio-degli-anni-80",
    cover:"https://i.ibb.co/My4Qk7B5/Figlio-Degli-Anni-80.png", audio:"DavideKra - 14 - Figlio degli anni '80.mp3", vtt:"DavideKra - 14 - Figlio degli anni '80.vtt" },

  { artist:"Davide*Kra", title:"Fammi Male", slug:"fammi-male",
    cover:"https://i.ibb.co/gLHkXXvm/Fammi-Male.jpg", audio:"DavideKra - 15 - Fammi Male.mp3", vtt:"DavideKra - 15 - Fammi Male.vtt" },

  { artist:"Davide*Kra", title:"Lettere Di Sangue", slug:"lettere-di-sangue",
    cover:"https://i.ibb.co/GfRv5W0K/Lettere-Di-Sangue.png", audio:"DavideKra - 16 - Lettere Di Sangue.mp3", vtt:"DavideKra - 16 - Lettere Di Sangue.vtt" },

  { artist:"Davide*Kra", title:"Mio Dio", slug:"mio-dio",
    cover:"https://i.ibb.co/kgnLN3L4/Mio-Dio.jpg", audio:"DavideKra - 17 - Mio Dio.mp3", vtt:"DavideKra - 17 - Mio Dio.vtt" },

  { artist:"Davide*Kra", title:"Sempre Meglio Di Niente", slug:"sempre-meglio-di-niente",
    cover:"https://i.ibb.co/d0fvdSFC/Sempre-Meglio-Di-Niente.png", audio:"DavideKra - 18 - Sempre Meglio Di Niente.mp3", vtt:"DavideKra - 18 - Sempre Meglio Di Niente.vtt" },

  { artist:"Davide*Kra", title:"Perdiamoci di vista", slug:"perdiamoci-di-vista",
    cover:"https://i.ibb.co/d4v5qQGL/Perdiamoci-Di-Vista.jpg", audio:"DavideKra - 19 - Perdiamoci di vista.mp3", vtt:"DavideKra - 19 - Perdiamoci Di Vista.vtt" },

  { artist:"Davide*Kra", title:"Ping Pong", slug:"ping-pong",
    cover:"https://i.ibb.co/FL9YQh6c/Ping-Pong.png", audio:"DavideKra - 20 - Ping Pong.mp3", vtt:"DavideKra - 20 - Ping Pong.vtt" },

  { artist:"Davide*Kra", title:"Nera", slug:"nera",
    cover:"https://i.ibb.co/G4bJyYzZ/Nera.png", audio:"DavideKra - 21 - Nera.mp3", vtt:"DavideKra - 21 - Nera.vtt" },

  { artist:"Davide*Kra", title:"Film Di Chaplin", slug:"film-di-chaplin",
    cover:"https://i.ibb.co/S4K7Y8xH/Film-Di-Chaplin.png", audio:"DavideKra - 22 - Film Di Champlin.mp3", vtt:"DavideKra - 22 - Film Di Champlin.vtt" }
];

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const encPath=(p)=>encodeURI(p);

const isMobile = window.matchMedia("(max-width: 780px), (hover: none) and (pointer: coarse)").matches;
document.body.dataset.mode = isMobile ? "mobile" : "desktop";

/* =========================
   Loader progress (covers only)
   ========================= */
const loader = document.getElementById("loader");
const loaderBar = document.getElementById("loaderBar");
const loaderPct = document.getElementById("loaderPct");

function setProgress(p){
  const pct = clamp(p,0,100);
  loaderBar.style.width = pct.toFixed(0) + "%";
  loaderPct.textContent = pct.toFixed(0) + "%";
}
function loadImage(src){
  return new Promise((resolve)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>resolve(true);
    img.onerror = ()=>resolve(false);
    img.src = src;
  });
}
async function preloadCovers(concurrency=4){
  const urls = tracks.map(t=>t.cover);
  const total = urls.length;
  let done = 0;
  let idx = 0;

  setProgress(0);

  const worker = async ()=>{
    while(idx < total){
      const my = idx++;
      await loadImage(urls[my]);
      done++;
      setProgress((done/total)*100);
    }
  };

  const workers = [];
  for(let i=0;i<Math.min(concurrency,total);i++) workers.push(worker());
  await Promise.all(workers);
}
async function runLoader(){
  // Gate minimo: prima cover + fonts
  const first = loadImage(tracks[0].cover);
  const fonts = (document.fonts && document.fonts.ready) ? document.fonts.ready.catch(()=>{}) : Promise.resolve();
  const all = preloadCovers(4).catch(()=>{});
  await Promise.all([first, fonts, new Promise(r=>setTimeout(r, 350))]);

  loader.classList.add("hide");
  setTimeout(()=>{ try{ loader.remove(); }catch(e){} }, 900);

  return all;
}

/* =========================
   Desktop 3D Gallery (stable)
   ========================= */
const world = document.getElementById("world");
const minimap = document.getElementById("minimap");
const line = document.getElementById("line");

const SCENE_DEPTH = 2000;
let cameraZ = 0;
let targetZ = 0;
let activeIndex = 0;
let lastActiveIndex = -1;

const scenes = tracks.map((t,i)=>{
  const el = document.createElement("div");
  el.className = "scene";
  el.dataset.index = String(i);

  const img = document.createElement("img");
  img.className = "cover";
  img.alt = t.title;
  img.decoding = "async";
  img.loading = (i <= 2) ? "eager" : "lazy";
  img.src = t.cover;

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `
    <div class="title">${t.title}</div>
    <div class="artist">${t.artist}</div>
  `;

  el.appendChild(img);
  el.appendChild(meta);

  el.addEventListener("click", ()=>{
    if(i !== activeIndex){
      goToIndex(i, true);
    }else{
      playOrToggle();
    }
  });

  world.appendChild(el);
  return { el, z:-i*SCENE_DEPTH, track:t, index:i };
});
const MAX_Z = SCENE_DEPTH * (tracks.length-1);

const dotItems = scenes.map((s,i)=>{
  const wrapper=document.createElement("div");
  wrapper.className="mm-item";
  wrapper.innerHTML=`<span class="mm-label">${s.track.title}</span><div class="mm-dot"></div>`;
  wrapper.addEventListener("click", ()=> goToIndex(i, false));
  minimap.appendChild(wrapper);
  return wrapper;
});

function computeActiveIndex(zVal){
  let bestI=0, bestD=Infinity;
  for(let i=0;i<scenes.length;i++){
    const rz = scenes[i].z + zVal;
    const d = Math.abs(rz);
    if(d < bestD){ bestD = d; bestI = i; }
  }
  return bestI;
}

function updateURL(){
  const t = scenes[activeIndex].track;
  const hash = "#" + t.slug;
  if(location.hash !== hash) history.replaceState(null, "", hash);
}

/* =========================
   Player UI
   ========================= */
const ptSong = document.getElementById("pt-song");
const ptArtist = document.getElementById("pt-artist");
const playerTitleBlock = document.getElementById("playerTitle");

const seekbar = document.getElementById("seekbar");
const seek = document.getElementById("seek");
const seekCur = document.getElementById("seekCur");
const seekDur = document.getElementById("seekDur");

const playBtn = document.getElementById("play");
const prevBtn = document.getElementById("prevTrack");
const nextBtn = document.getElementById("nextTrack");
const shuffleBtn = document.getElementById("shuffle");
const repeatBtn  = document.getElementById("repeat");

function updateHUD(){
  const t = scenes[activeIndex].track;
  ptArtist.textContent = t.artist;
  ptSong.textContent   = t.title;
}

/* =========================
   Shuffle / Repeat
   ========================= */
let shuffleOn = false;
let repeatMode = 0; // 0=no, 1=all, 2=one
let shuffleBag = [];
let shuffleHistory = [];

function refillShuffleBag(excludeIndex){
  shuffleBag = [];
  for(let i=0;i<scenes.length;i++){
    if(i !== excludeIndex) shuffleBag.push(i);
  }
}
function shufflePickNext(excludeIndex, allowRefill){
  if(shuffleBag.length === 0){
    if(!allowRefill) return null;
    refillShuffleBag(excludeIndex);
  }
  if(shuffleBag.length === 0) return null;
  const j = (Math.random()*shuffleBag.length)|0;
  return shuffleBag.splice(j,1)[0];
}
function shuffleNotePlayed(i){
  if(!shuffleOn) return;
  const p = shuffleBag.indexOf(i);
  if(p !== -1) shuffleBag.splice(p,1);
  if(shuffleHistory[shuffleHistory.length-1] !== i) shuffleHistory.push(i);
}
function updateShuffleRepeatUI(){
  shuffleBtn.classList.toggle("on", shuffleOn);
  shuffleBtn.textContent = shuffleOn ? "SHUFFLE: ON" : "SHUFFLE: OFF";

  repeatBtn.classList.toggle("on", repeatMode !== 0);
  repeatBtn.textContent = (repeatMode===0) ? "REPEAT: NO" : (repeatMode===1) ? "REPEAT: ALL" : "REPEAT: ONE";

  // mobile mirrors
  if(isMobile){
    document.getElementById("mShuffle").classList.toggle("on", shuffleOn);
    document.getElementById("mShuffle").textContent = shuffleOn ? "SHUFFLE: ON" : "SHUFFLE: OFF";
    document.getElementById("mRepeat").classList.toggle("on", repeatMode !== 0);
    document.getElementById("mRepeat").textContent = (repeatMode===0) ? "REPEAT: NO" : (repeatMode===1) ? "REPEAT: ALL" : "REPEAT: ONE";
  }
}
function setShuffle(on){
  shuffleOn = !!on;
  shuffleHistory = [];
  shuffleBag = [];
  const exclude = (playingIndex !== null) ? playingIndex : activeIndex;
  if(shuffleOn){
    refillShuffleBag(exclude);
    if(playingIndex !== null) shuffleHistory = [playingIndex];
  }
  updateShuffleRepeatUI();
}
function cycleRepeat(){
  repeatMode = (repeatMode + 1) % 3;
  updateShuffleRepeatUI();
}
shuffleBtn.addEventListener("click", ()=> setShuffle(!shuffleOn));
repeatBtn.addEventListener("click", cycleRepeat);

/* =========================
   Audio engine (crossfade) + Karaoke
   ========================= */
const audioA = document.getElementById("audioA");
const audioB = document.getElementById("audioB");
const audios = [audioA, audioB];

let audioCtx=null, srcA=null, srcB=null, gA=null, gB=null;
let currentPlayer=0, playingIndex=null;
let vttSession=0, currentTrackEl=null;

function ensureAudioGraph(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  srcA = audioCtx.createMediaElementSource(audioA);
  srcB = audioCtx.createMediaElementSource(audioB);
  gA = audioCtx.createGain();
  gB = audioCtx.createGain();
  gA.gain.value = 1;
  gB.gain.value = 0;
  srcA.connect(gA).connect(audioCtx.destination);
  srcB.connect(gB).connect(audioCtx.destination);
}
function getCurrentAudio(){ return audios[currentPlayer]; }
function getOtherAudio(){ return audios[1-currentPlayer]; }
function getCurrentGain(){ return currentPlayer===0 ? gA : gB; }
function getOtherGain(){ return currentPlayer===0 ? gB : gA; }

function clearKaraoke(){
  vttSession++;
  line.style.opacity = 0;
  line.textContent = "";
  if(currentTrackEl){
    try{ currentTrackEl.remove(); }catch(e){}
    currentTrackEl=null;
  }
}
function bindKaraokeTo(playerEl, trackObj){
  clearKaraoke();
  const mySession = vttSession;
  const tr = document.createElement("track");
  tr.kind="subtitles"; tr.srclang="it"; tr.label="lyrics";
  tr.src = encPath(trackObj.vtt);
  tr.default = true;
  playerEl.appendChild(tr);
  currentTrackEl = tr;

  tr.addEventListener("load", ()=>{
    if(mySession!==vttSession) return;
    const tt = tr.track; tt.mode="hidden";
    let lastCue=null;

    const refresh = ()=>{
      if(mySession!==vttSession) return;
      if(playingIndex===null || activeIndex!==playingIndex){ line.style.opacity=0; return; }
      if(getCurrentAudio().paused){ line.style.opacity=0; return; }
      const a = tt.activeCues;
      if(!a || !a.length){ line.style.opacity=0; return; }
      const cue = a[0];
      if(cue === lastCue) return;
      lastCue = cue;

      line.style.opacity = 0;
      line.style.transform = "translateY(10px)";
      setTimeout(()=>{
        if(mySession!==vttSession) return;
        if(playingIndex===null || activeIndex!==playingIndex){ line.style.opacity=0; return; }
        if(getCurrentAudio().paused){ line.style.opacity=0; return; }
        line.textContent = cue.text;
        line.style.transform = "translateY(0)";
        line.style.opacity = 1;
      }, 90);
    };

    tt.addEventListener("cuechange", refresh);
    playerEl.addEventListener("timeupdate", refresh);
    playerEl.addEventListener("seeked", ()=>{ lastCue=null; refresh(); });
    refresh();
  });
}

async function playIndex(index, mode){
  ensureAudioGraph();
  await audioCtx.resume();

  const wantIndex = index;
  const want = scenes[wantIndex].track;

  if(playingIndex===null){
    playingIndex = wantIndex;
    shuffleNotePlayed(wantIndex);

    const a = getCurrentAudio();
    a.src = encPath(want.audio);
    a.load();
    bindKaraokeTo(a, want);
    await a.play();
    updatePlayingUI();
    return;
  }

  if(playingIndex===wantIndex){
    const a = getCurrentAudio();
    if(mode==="toggle"){
      if(a.paused) await a.play();
      else { a.pause(); line.style.opacity=0; }
    }else{
      if(a.paused) await a.play();
    }
    updatePlayingUI();
    return;
  }

  const FADE = 1.1;
  const prevAudio = getCurrentAudio();
  const nextAudio = getOtherAudio();
  const prevGain  = getCurrentGain();
  const nextGain  = getOtherGain();

  playingIndex = wantIndex;
  shuffleNotePlayed(wantIndex);

  nextAudio.pause();
  nextAudio.currentTime = 0;
  nextAudio.src = encPath(want.audio);
  nextAudio.load();
  bindKaraokeTo(nextAudio, want);

  nextGain.gain.cancelScheduledValues(audioCtx.currentTime);
  prevGain.gain.cancelScheduledValues(audioCtx.currentTime);
  nextGain.gain.setValueAtTime(0, audioCtx.currentTime);
  prevGain.gain.setValueAtTime(prevGain.gain.value, audioCtx.currentTime);

  await nextAudio.play();
  nextGain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + FADE);
  prevGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + FADE);

  setTimeout(()=>{
    try{
      prevAudio.pause();
      prevAudio.removeAttribute("src");
      prevAudio.load();
    }catch(e){}
  }, (FADE*1000)+80);

  currentPlayer = 1-currentPlayer;
  updatePlayingUI();
}

async function playOrToggle(){
  await playIndex(activeIndex, "toggle");
}

/* Auto-next rules */
function computeNextAutoIndex(){
  if(playingIndex === null) return null;
  if(repeatMode === 2) return playingIndex;

  const base = playingIndex;

  if(shuffleOn){
    const allowRefill = (repeatMode === 1);
    return shufflePickNext(base, allowRefill);
  }

  const nxt = base + 1;
  if(nxt < scenes.length) return nxt;
  if(repeatMode === 1) return 0;
  return null;
}

function handleEnded(endedEl){
  if(playingIndex===null) return;
  if(endedEl !== getCurrentAudio()) return;

  if(repeatMode === 2){
    endedEl.currentTime = 0;
    endedEl.play().catch(()=>{});
    updatePlayingUI();
    return;
  }

  const nextIndex = computeNextAutoIndex();
  if(nextIndex === null){
    playingIndex = null;
    clearKaraoke();
    updatePlayingUI();
    return;
  }
  goToIndex(nextIndex, true);
}
audioA.addEventListener("ended", ()=>handleEnded(audioA));
audioB.addEventListener("ended", ()=>handleEnded(audioB));

/* =========================
   Seekbar (desktop + mobile)
   ========================= */
const fmtTime = (sec)=>{
  if(!isFinite(sec) || sec < 0) sec = 0;
  const m = Math.floor(sec/60);
  const s = Math.floor(sec%60);
  return `${m}:${String(s).padStart(2,"0")}`;
};

let isSeeking = false;
let resumeAfterSeek = false;

function syncSeekUI(){
  const a = getCurrentAudio();
  const isCurrent = (playingIndex !== null && activeIndex === playingIndex && a);

  // desktop
  if(!isCurrent){
    seek.disabled = true;
    seek.value = 0;
    seekCur.textContent="0:00";
    seekDur.textContent="0:00";
    return;
  }

  const dur = a.duration;
  if(!isFinite(dur) || dur<=0){
    seek.disabled = true;
    seekCur.textContent = fmtTime(a.currentTime||0);
    seekDur.textContent = "0:00";
    return;
  }

  seek.disabled = false;
  seekDur.textContent = fmtTime(dur);

  if(!isSeeking){
    const ratio = clamp((a.currentTime||0)/dur, 0, 1);
    seek.value = Math.round(ratio*1000);
    seekCur.textContent = fmtTime(a.currentTime||0);
  }
}
function onSeekStart(){
  if(playingIndex===null || activeIndex!==playingIndex) return;
  const a=getCurrentAudio();
  const dur=a.duration;
  if(!isFinite(dur) || dur<=0) return;

  isSeeking=true;
  resumeAfterSeek = !a.paused;
  if(resumeAfterSeek) a.pause();
}
function onSeekMove(){
  if(!isSeeking) return;
  const a=getCurrentAudio();
  const dur=a.duration;
  if(!isFinite(dur) || dur<=0) return;
  const t=(seek.value/1000)*dur;
  seekCur.textContent = fmtTime(t);
}
async function onSeekEnd(){
  if(!isSeeking) return;
  const a=getCurrentAudio();
  const dur=a.duration;
  isSeeking=false;

  if(isFinite(dur) && dur>0){
    a.currentTime = clamp((seek.value/1000)*dur, 0, Math.max(0, dur-0.001));
  }
  if(resumeAfterSeek){
    try{
      ensureAudioGraph();
      await audioCtx.resume();
      await a.play();
    }catch(e){}
  }
  resumeAfterSeek=false;
  syncSeekUI();
  updatePlayingUI();
}

seek.addEventListener("pointerdown", onSeekStart);
seek.addEventListener("input", onSeekMove);
seek.addEventListener("change", onSeekEnd);
seek.addEventListener("pointerup", onSeekEnd);
seek.addEventListener("touchend", onSeekEnd);

[audioA,audioB].forEach(el=>{
  el.addEventListener("timeupdate", (e)=>{ if(e.target===getCurrentAudio()) { syncSeekUI(); syncMobileSeekUI(); } });
  el.addEventListener("loadedmetadata", (e)=>{ if(e.target===getCurrentAudio()) { syncSeekUI(); syncMobileSeekUI(); } });
  el.addEventListener("durationchange",(e)=>{ if(e.target===getCurrentAudio()) { syncSeekUI(); syncMobileSeekUI(); } });
  el.addEventListener("play", (e)=>{ if(e.target===getCurrentAudio()) { syncSeekUI(); syncMobileSeekUI(); } });
  el.addEventListener("pause",(e)=>{ if(e.target===getCurrentAudio()) { syncSeekUI(); syncMobileSeekUI(); } });
});

/* =========================
   Controls (desktop)
   ========================= */
document.getElementById("play").addEventListener("click", playOrToggle);

document.getElementById("back").addEventListener("click", ()=>{
  const a=getCurrentAudio();
  a.currentTime = Math.max(0, (a.currentTime||0) - 10);
});
document.getElementById("forward").addEventListener("click", ()=>{
  const a=getCurrentAudio();
  a.currentTime = Math.min((a.duration||0), (a.currentTime||0) + 10);
});

function computeNextManual(){
  const base = (playingIndex !== null) ? playingIndex : activeIndex;
  if(shuffleOn) return shufflePickNext(base, true);
  const nxt = base + 1;
  if(nxt < scenes.length) return nxt;
  if(repeatMode === 1) return 0;
  return null;
}
function computePrevManual(){
  const base = (playingIndex !== null) ? playingIndex : activeIndex;
  if(shuffleOn){
    if(shuffleHistory.length > 1){
      shuffleHistory.pop();
      return shuffleHistory[shuffleHistory.length-1];
    }
    return base;
  }
  const prv = base - 1;
  if(prv >= 0) return prv;
  if(repeatMode === 1) return scenes.length - 1;
  return 0;
}
prevBtn.addEventListener("click", ()=>{
  const idx = computePrevManual();
  if(idx===null) return;
  goToIndex(idx, true);
});
nextBtn.addEventListener("click", ()=>{
  const idx = computeNextManual();
  if(idx===null) return;
  goToIndex(idx, true);
});

/* Wheel navigation (desktop) */
function scrub(deltaY){
  if(playingIndex===null) return;
  const a=getCurrentAudio();
  const seconds=(deltaY/100)*2.0;
  a.currentTime = clamp(a.currentTime + seconds, 0, (a.duration||a.currentTime+10));
  line.style.opacity=0;
}
if(!isMobile){
  window.addEventListener("wheel",(e)=>{
    e.preventDefault();
    if(e.shiftKey){ scrub(e.deltaY); return; }
    targetZ = clamp(targetZ + e.deltaY * 0.95, 0, MAX_Z);
    // snap morbido
    const nearest = Math.round(targetZ / SCENE_DEPTH) * SCENE_DEPTH;
    targetZ = clamp(nearest, 0, MAX_Z);
  }, {passive:false});
}

/* =========================
   Desktop render loop
   ========================= */
let pendingPlayIndex = null;
function goToIndex(i, autoplay){
  if(isMobile){
    activeIndex = clamp(i, 0, scenes.length-1);
    lastActiveIndex = -1;
    updateMobileNow();
    updateMobileListState();
    updateMobileHash();
    if(autoplay) playIndex(activeIndex, "force");
    return;
  }
  targetZ = clamp(i*SCENE_DEPTH, 0, MAX_Z);
  pendingPlayIndex = autoplay ? i : null;
}

function updateScenes(){
  activeIndex = computeActiveIndex(cameraZ);

  if(activeIndex !== lastActiveIndex){
    updateHUD();
    updateURL();

    dotItems.forEach((d,idx)=>{
      d.classList.toggle("active", idx===activeIndex);
    });

    lastActiveIndex = activeIndex;
  }

  for(const s of scenes){
    const rz = s.z + cameraZ;
    const dist = Math.abs(rz);
    const t = clamp(1 - (dist/SCENE_DEPTH), 0, 1);
    const scale = 0.72 + t*0.28;
    const opacity = t;

    // trasformazioni semplici e stabili
    s.el.style.transform = `translateZ(${rz}px) scale(${scale})`;
    s.el.style.opacity = opacity.toFixed(3);
    s.el.style.pointerEvents = (opacity > 0.55) ? "auto" : "none";
  }

  updatePlayingUI();
}

function tick(){
  const diff = (targetZ - cameraZ);
  cameraZ += diff * 0.14;
  if(Math.abs(diff) < 0.35) cameraZ = targetZ;

  if(pendingPlayIndex !== null && Math.abs(diff) < 3){
    const idx = pendingPlayIndex;
    pendingPlayIndex = null;
    playIndex(idx, "force");
  }

  updateScenes();
  requestAnimationFrame(tick);
}

/* =========================
   Playing UI
   ========================= */
function updatePlayingUI(){
  const a = getCurrentAudio();
  const isPlaying = (playingIndex!==null && a && !a.paused);

  playBtn.textContent = (isPlaying && activeIndex===playingIndex) ? "PAUSE" : "PLAY";

  scenes.forEach((s,i)=>{
    s.el.classList.toggle("is-playing", (i===playingIndex && isPlaying));
  });
  dotItems.forEach((d,i)=>{
    d.classList.toggle("playing", (i===playingIndex && isPlaying));
  });

  // seek visible only when stai guardando la traccia in riproduzione
  seekbar.classList.toggle("visible", (playingIndex!==null && activeIndex===playingIndex));
  syncSeekUI();

  if(playingIndex===null || activeIndex!==playingIndex || a.paused){
    line.style.opacity=0;
  }

  // Mobile mirrors
  if(isMobile){
    const mPlay = document.getElementById("mPlay");
    mPlay.textContent = (isPlaying && activeIndex===playingIndex) ? "PAUSE" : "PLAY";
    updateMobileListState();
  }
}

/* =========================
   Cursor neon (desktop only)
   ========================= */
const cursorCanvas = document.getElementById("cursor-canvas");
const cursorCtx = cursorCanvas.getContext("2d", { alpha:true });

let ccw=0, cch=0, cdpr=1;
function resizeCursorCanvas(){
  cdpr = window.devicePixelRatio || 1;
  ccw = cursorCanvas.width  = Math.floor(window.innerWidth * cdpr);
  cch = cursorCanvas.height = Math.floor(window.innerHeight * cdpr);
  cursorCanvas.style.width  = window.innerWidth + "px";
  cursorCanvas.style.height = window.innerHeight + "px";
  cursorCtx.setTransform(1,0,0,1,0,0);
}
window.addEventListener("resize", resizeCursorCanvas);
resizeCursorCanvas();

let mx = window.innerWidth/2, my = window.innerHeight/2;
let trail = [];
const TRAIL_MAX = 34;

if(!isMobile){
  window.addEventListener("mousemove",(e)=>{
    mx = e.clientX;
    my = e.clientY;
    trail.push({x:mx,y:my,t:performance.now()});
    if(trail.length > TRAIL_MAX) trail.shift();
  });
}

function drawCursor(){
  const now = performance.now();
  cursorCtx.clearRect(0,0,ccw,cch);

  cursorCtx.save();
  cursorCtx.globalCompositeOperation = "lighter";
  cursorCtx.lineCap = "round";
  cursorCtx.lineJoin = "round";

  for(let i=1;i<trail.length;i++){
    const a=trail[i-1], b=trail[i];
    const age = (now - b.t);
    const alpha = clamp(1 - age/520, 0, 1);
    const w = (9 - i*(6/TRAIL_MAX)) * cdpr;

    const isAlt = (i % 6) < 3;
    const col = isAlt
      ? `rgba(170,60,255,${0.26*alpha})`
      : `rgba(255,230,60,${0.20*alpha})`;

    cursorCtx.strokeStyle = col;
    cursorCtx.lineWidth = Math.max(1, w);
    cursorCtx.beginPath();
    cursorCtx.moveTo(a.x*cdpr, a.y*cdpr);
    cursorCtx.lineTo(b.x*cdpr, b.y*cdpr);
    cursorCtx.stroke();
  }

  const pulse = 0.6 + Math.sin(now*0.012)*0.4;
  const r = (6 + pulse*3) * cdpr;

  cursorCtx.shadowBlur = 26 * cdpr;
  cursorCtx.shadowColor = "rgba(170,60,255,0.85)";
  cursorCtx.fillStyle = "rgba(255,255,255,0.92)";
  cursorCtx.beginPath();
  cursorCtx.arc(mx*cdpr, my*cdpr, r, 0, Math.PI*2);
  cursorCtx.fill();

  cursorCtx.shadowBlur = 38 * cdpr;
  cursorCtx.shadowColor = "rgba(255,230,60,0.55)";
  cursorCtx.fillStyle = "rgba(170,60,255,0.24)";
  cursorCtx.beginPath();
  cursorCtx.arc(mx*cdpr, my*cdpr, r*1.7, 0, Math.PI*2);
  cursorCtx.fill();

  cursorCtx.restore();

  trail = trail.filter(p => (now - p.t) < 700);
  requestAnimationFrame(drawCursor);
}

/* =========================
   Mobile app (light + swipe up/down)
   ========================= */
const mobileApp = document.getElementById("mobileApp");
const mCover = document.getElementById("mCover");
const mSong = document.getElementById("mSong");
const mArtist = document.getElementById("mArtist");
const mLyric = document.getElementById("mLyric");
const mList = document.getElementById("mList");

const mSeek = document.getElementById("mSeek");
const mCur = document.getElementById("mCur");
const mDur = document.getElementById("mDur");

const mPrev = document.getElementById("mPrev");
const mPlay = document.getElementById("mPlay");
const mNext = document.getElementById("mNext");
const mShuffle = document.getElementById("mShuffle");
const mRepeat  = document.getElementById("mRepeat");

let mItems = [];

function updateMobileHash(){
  const t = scenes[activeIndex].track;
  const hash = "#" + t.slug;
  if(location.hash !== hash) history.replaceState(null, "", hash);
}
function updateMobileNow(){
  const t = scenes[activeIndex].track;
  mCover.style.backgroundImage = `url("${t.cover}")`;
  mSong.textContent = t.title;
  mArtist.textContent = t.artist;
}
function updateMobileListState(){
  const a = getCurrentAudio();
  const isPlaying = (playingIndex!==null && a && !a.paused);
  mItems.forEach((obj,i)=>{
    obj.btn.classList.toggle("active", i===activeIndex);
    const p = (i===playingIndex && isPlaying);
    obj.btn.classList.toggle("playing", p);
    obj.state.textContent = p ? "PLAY" : "";
  });
}
function initMobileList(){
  mList.innerHTML = "";
  mItems = scenes.map((s,i)=>{
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="mTrack";
    btn.innerHTML = `
      <div class="cov" style="background-image:url('${s.track.cover}')"></div>
      <div class="txt">
        <div class="t">${s.track.title}</div>
        <div class="a">${s.track.artist}</div>
      </div>
      <div class="state"></div>
    `;
    const state = btn.querySelector(".state");
    btn.addEventListener("click", ()=> goToIndex(i, true));
    mList.appendChild(btn);
    return {btn, state};
  });
}
function syncMobileSeekUI(){
  if(!isMobile) return;
  const a = getCurrentAudio();
  const isCurrent = (playingIndex !== null && activeIndex === playingIndex && a);
  if(!isCurrent){
    mSeek.disabled = true;
    mSeek.value = 0;
    mCur.textContent="0:00";
    mDur.textContent="0:00";
    return;
  }
  const dur = a.duration;
  if(!isFinite(dur) || dur<=0){
    mSeek.disabled = true;
    mCur.textContent=fmtTime(a.currentTime||0);
    mDur.textContent="0:00";
    return;
  }
  mSeek.disabled = false;
  mDur.textContent = fmtTime(dur);

  if(!isSeekingMobile){
    const ratio = clamp((a.currentTime||0)/dur, 0, 1);
    mSeek.value = Math.round(ratio*1000);
    mCur.textContent = fmtTime(a.currentTime||0);
  }
}

let isSeekingMobile = false;
let resumeAfterSeekMobile = false;

function mSeekStart(){
  if(playingIndex===null || activeIndex!==playingIndex) return;
  const a=getCurrentAudio();
  const dur=a.duration;
  if(!isFinite(dur) || dur<=0) return;
  isSeekingMobile=true;
  resumeAfterSeekMobile = !a.paused;
  if(resumeAfterSeekMobile) a.pause();
}
function mSeekMove(){
  if(!isSeekingMobile) return;
  const a=getCurrentAudio();
  const dur=a.duration;
  if(!isFinite(dur) || dur<=0) return;
  const t=(mSeek.value/1000)*dur;
  mCur.textContent = fmtTime(t);
}
async function mSeekEnd(){
  if(!isSeekingMobile) return;
  const a=getCurrentAudio();
  const dur=a.duration;
  isSeekingMobile=false;

  if(isFinite(dur) && dur>0){
    a.currentTime = clamp((mSeek.value/1000)*dur, 0, Math.max(0, dur-0.001));
  }
  if(resumeAfterSeekMobile){
    try{
      ensureAudioGraph();
      await audioCtx.resume();
      await a.play();
    }catch(e){}
  }
  resumeAfterSeekMobile=false;
  syncMobileSeekUI();
  updatePlayingUI();
}

mSeek.addEventListener("pointerdown", mSeekStart);
mSeek.addEventListener("input", mSeekMove);
mSeek.addEventListener("change", mSeekEnd);
mSeek.addEventListener("pointerup", mSeekEnd);
mSeek.addEventListener("touchend", mSeekEnd);

mPrev.addEventListener("click", ()=>{ const i = computePrevManual(); if(i!==null) goToIndex(i,true); });
mNext.addEventListener("click", ()=>{ const i = computeNextManual(); if(i!==null) goToIndex(i,true); });
mPlay.addEventListener("click", ()=>{
  if(playingIndex===null || playingIndex!==activeIndex) playIndex(activeIndex,"force");
  else playOrToggle();
});
mCover.addEventListener("click", ()=>{
  if(playingIndex===null || playingIndex!==activeIndex) playIndex(activeIndex,"force");
  else playOrToggle();
});
mShuffle.addEventListener("click", ()=> setShuffle(!shuffleOn));
mRepeat.addEventListener("click", cycleRepeat);

/* swipe up/down to change track (avoid when starting from list) */
function initMobileSwipe(){
  let sx=0, sy=0, st=0, tracking=false;

  mobileApp.addEventListener("touchstart",(e)=>{
    const t = e.touches && e.touches[0];
    if(!t) return;
    if(e.target && e.target.closest && e.target.closest("#mList")) return;
    tracking=true;
    sx=t.clientX; sy=t.clientY; st=Date.now();
  }, {passive:true});

  mobileApp.addEventListener("touchend",(e)=>{
    if(!tracking) return;
    tracking=false;
    const t = e.changedTouches && e.changedTouches[0];
    if(!t) return;
    const dx = t.clientX - sx;
    const dy = t.clientY - sy;
    const dt = Date.now() - st;

    if(dt < 650 && Math.abs(dy) > 55 && Math.abs(dy) > Math.abs(dx)*1.2){
      if(dy < 0){
        const nxt = (activeIndex + 1) % scenes.length;
        goToIndex(nxt, true);
      }else{
        const prv = (activeIndex - 1 + scenes.length) % scenes.length;
        goToIndex(prv, true);
      }
    }
  }, {passive:true});
}

/* Karaoke to mobile lyric line */
function mirrorLyricToMobile(){
  if(!isMobile) return;
  // copio solo testo corrente
  const txt = line.textContent || "";
  mLyric.textContent = txt;
}

/* Aggiorna mobile lyric quando karaoke cambia */
const karaokeObserver = new MutationObserver(()=>{ mirrorLyricToMobile(); });
karaokeObserver.observe(line, {childList:true, characterData:true, subtree:true});

/* =========================
   Hash jump + init
   ========================= */
function jumpFromHash(){
  const hash = location.hash.slice(1);
  if(!hash) return;
  const idx = tracks.findIndex(t => t.slug === hash);
  if(idx >= 0){
    activeIndex = idx;
    targetZ = idx * SCENE_DEPTH;
    cameraZ = targetZ;
  }
}

/* =========================
   Start
   ========================= */
window.addEventListener("load", async ()=>{
  runLoader().catch(()=>{});

  jumpFromHash();
  updateHUD();
  playerTitleBlock.classList.add("visible");
  updateShuffleRepeatUI();

  if(isMobile){
    // mobile: niente 3D, solo lista
    initMobileList();
    initMobileSwipe();
    updateMobileNow();
    updateMobileListState();
    updateMobileHash();
    syncMobileSeekUI();
    updatePlayingUI();
    return;
  }

  // desktop: start loops
  // inizio con posizionamento
  targetZ = clamp(activeIndex*SCENE_DEPTH, 0, MAX_Z);
  cameraZ = targetZ;
  updateScenes();
  requestAnimationFrame(tick);
  requestAnimationFrame(drawCursor);
});

/* =========================
   Desktop updateScenes (called in init)
   ========================= */
function updateScenes(){
  activeIndex = computeActiveIndex(cameraZ);

  if(activeIndex !== lastActiveIndex){
    updateHUD();
    updateURL();

    dotItems.forEach((d,idx)=>{
      d.classList.toggle("active", idx===activeIndex);
    });

    lastActiveIndex = activeIndex;
  }

  for(const s of scenes){
    const rz = s.z + cameraZ;
    const dist = Math.abs(rz);
    const t = clamp(1 - (dist/SCENE_DEPTH), 0, 1);
    const scale = 0.72 + t*0.28;
    const opacity = t;

    s.el.style.transform = `translateZ(${rz}px) scale(${scale})`;
    s.el.style.opacity = opacity.toFixed(3);
    s.el.style.pointerEvents = (opacity > 0.55) ? "auto" : "none";
  }

  updatePlayingUI();
  mirrorLyricToMobile();
}
</script>

</body>
</html>
